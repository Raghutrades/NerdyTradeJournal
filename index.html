<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nerdys - HolisticProcess</title>
    <!-- Favicon and Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin (for pie/doughnut charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Define CSS Variables for theming */
        :root { /* Dark Theme Variables (default) */
            --body-bg: #0d1117;
            --body-text: #c9d1d9; /* Base text color */
            --card-bg: #1f2937; /* Background for larger content blocks (modal, table headers) */
            --section-bg: #1f2937; /* Used for main content div backgrounds */
            --input-group-bg: #2d3748; /* Background for input wrappers and emotion items */
            --input-text: #c9d1d9; /* Text color inside inputs and icons in input groups */
            --accent-primary: #6366f1; /* Primary accent color (e.g., active states, buttons) */
            --accent-text-light: #a78bfa; /* Lighter accent text for headers */
            --border-color: #4a5568; /* Border color for cards/sections/inputs */
            --chart-grid-color: rgba(255,255,255,0.1); /* Chart grid lines */
            --chart-text-color: #c9d1d9; /* Chart axis labels and ticks */
            --btn-toggle-bg: #2d3748; /* Background for filter toggle buttons */
            --btn-toggle-text: #c9d1d9; /* Text for filter toggle buttons */
            --neutral-bg-hover: #111827; /* Hover background for neutral elements */
            --red-text: #ef4444; /* Red color for negative PnL */
            --green-text: #22c55e; /* Green color for positive PnL */

            /* User-provided theme variables - Harmonized */
            --card: var(--card-bg); /* Directly maps to existing card background */
            --border: var(--border-color); /* Directly maps to existing border color */
            --gold-primary: #FFD700; /* Distinct gold color for primary gold elements */
            --gold-secondary: #DAA520; /* Distinct gold color for secondary gold elements */
            --text: var(--body-text); /* Maps to body text for general text */
            --accent: var(--accent-primary); /* Maps to primary accent color */
            --golden-glow: #FFD700; /* For golden glow */

            /* Sidebar active/hover colors - these will be overridden for sidebar specifically */
            --sidebar-active-bg: #4338ca; /* Darker indigo for active */
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #3730a3; /* Even darker indigo for hover */
        }

        html.light { /* Light Theme Variables */
            --body-bg: #f0f2f5;
            --body-text: #333; /* Darker text for light theme */
            --card-bg: #ffffff;
            --section-bg: #ffffff;
            --input-group-bg: #e2e8f0; /* Lighter background for input wrappers */
            --input-text: #333; /* Darker input text */
            --accent-primary: #4f46e5;
            --accent-text-light: #6366f1;
            --border-color: #cbd5e1; /* Lighter border color */
            --chart-grid-color: rgba(0,0,0,0.1);
            --chart-text-color: #333; /* Darker chart text */
            --btn-toggle-bg: #e0e2e5;
            --btn-toggle-text: #333; /* Darker button toggle text */
            --neutral-bg-hover: #f9fafb; /* Very light hover background */
            --red-text: #dc2626;
            --green-text: #16a34a;

            /* User-provided theme variables - Harmonized for Light Theme */
            --card: var(--card-bg);
            --border: var(--border-color);
            --gold-primary: #FFBF00; /* Slightly different gold for light theme */
            --gold-secondary: #B8860B;
            --text: var(--body-text);
            --accent: var(--accent-primary);
            --golden-glow: #FFC04D; /* Lighter gold for light theme glow */

            /* Sidebar active/hover colors for light theme - these will be overridden for sidebar specifically */
            --sidebar-active-bg: #4338ca; /* Keeping these dark for sidebar */
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #3730a3;
        }

        /* Base styles using variables */
        body {
            font-family: "Inter", sans-serif;
            background-color: var(--body-bg);
            color: var(--body-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* General Tailwind overrides using variables for consistency */
        /* These classes are now specifically targeted within the sidebar or main content */
        .border-gray-700 { border-color: var(--border-color); }
        .bg-gray-900 { background-color: var(--section-bg); }

        /* Main content blocks, cards, and input groups */
        .bg-zinc-800 { background-color: var(--section-bg); border-color: var(--border-color); }
        .bg-zinc-700 { background-color: var(--input-group-bg); border-color: var(--border-color); }
        .text-zinc-400 { color: var(--input-text); } /* Icons and placeholder text in input groups */
        .text-zinc-300 { color: var(--body-text); } /* General secondary text */

        /* Input styling adjustments */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea {
            background-color: transparent !important; /* Always transparent to inherit from input-group */
            border: none;
            outline: none;
            box-shadow: none;
            width: 100%;
            color: var(--input-text) !important; /* Input text color */
            padding: 0.5rem 0.75rem;
            font-size: 0.95rem;
        }

        /* Specific styling for select elements within input-group for better contrast */
        .input-group select {
            background-color: var(--input-group-bg) !important;
            color: var(--input-text) !important;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Default arrow for dark theme */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23c9d1d9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        html.light .input-group select {
            /* Darker arrow for light theme */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        input:focus, select:focus, textarea:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: var(--accent-primary) !important;
        }
        .input-group {
            display: flex;
            align-items: center;
            background-color: var(--input-group-bg);
            border-radius: 0.375rem;
            padding-right: 0.75rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        .input-group:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 50%, transparent);
        }
        .input-group i {
            color: var(--input-text);
            margin-right: 0.75rem;
            flex-shrink: 0;
            padding-left: 0.75rem;
        }


        /* Responsive table */
        .trade-table-container {
            overflow-x: auto;
        }
        .trade-table {
            width: 100%;
            border-collapse: collapse;
        }
        .trade-table th, .trade-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .trade-table th {
            background-color: var(--card-bg);
            font-weight: 600;
            color: var(--body-text);
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .trade-table tr:hover {
            background-color: var(--neutral-bg-hover);
        }

        /* Button styling */
        .btn-primary {
            background-image: linear-gradient(to right, var(--accent-primary), color-mix(in srgb, var(--accent-primary) 80%, purple));
            color: white;
            font-weight: bold;
            padding: 0.625rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .btn-primary:hover {
            transform: scale(1.05);
            background-image: linear-gradient(to right, color-mix(in srgb, var(--accent-primary) 80%, purple), var(--accent-primary));
        }

        .btn-secondary {
            background-color: color-mix(in srgb, var(--body-bg) 80%, var(--body-text) 20%);
            color: var(--body-text);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: color-mix(in srgb, var(--body-bg) 70%, var(--body-text) 30%);
        }
        
        .btn-danger {
            background-color: var(--red-text);
            color: white;
            font-weight: bold;
            padding: 0.625rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background-color: color-mix(in srgb, var(--red-text) 80%, black);
            transform: scale(1.05);
        }

        /* Toggle button for filters (Dashboard) */
        .btn-toggle {
            background-color: var(--btn-toggle-bg);
            color: var(--btn-toggle-text);
            @apply px-3 py-1 rounded-md text-sm transition-colors duration-200;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .btn-toggle:hover:not(.active) {
            background-color: color-mix(in srgb, var(--btn-toggle-bg) 80%, var(--accent-primary) 20%);
            color: white;
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.2), 0 4px 8px -3px rgba(0, 0, 0, 0.1);
        }
        .btn-toggle.active {
            background-color: var(--accent-primary); /* Use solid color for active state */
            color: white;
            @apply shadow-md;
            border-color: var(--accent-primary);
            box-shadow: 0 5px 15px color-mix(in srgb, var(--accent-primary) 40%, transparent);
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            transform: translateY(-50px);
            animation: slideIn 0.3s forwards ease-out;
            color: var(--body-text); /* Ensure modal content text is readable */
        }

        @keyframes slideIn {
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close-button {
            color: var(--body-text);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: var(--accent-primary);
            text-decoration: none;
            cursor: pointer;
        }

        /* New styles for emoji emotion picker */
        .emotion-emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
        }

        .emotion-emoji-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--input-group-bg);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
            font-size: 0.85rem;
            text-align: center;
            color: var(--input-text);
        }

        .emotion-emoji-item.selected {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: scale(1.05);
            box-shadow: 0 0 10px color-mix(in srgb, var(--accent-primary) 50%, transparent);
            color: white;
        }

        .emotion-emoji-item:hover:not(.selected) {
            background-color: color-mix(in srgb, var(--input-group-bg) 80%, var(--accent-primary) 20%);
            border-color: var(--accent-primary);
        }
        .emotion-emoji-item span.emoji {
            font-size: 1.8rem;
            margin-bottom: 4px;
        }

        /* Specific styles for Reflection entries */
        .reflection-entry {
            background-color: var(--input-group-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        /* Ensure chart canvases have a defined height within their parent */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* Hide data labels by default for all Chart.js charts */
        .chartjs-datalabels-group { display: none; }

        /* Custom styling for form sections */
        .form-section {
            background-color: var(--input-group-bg);
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .form-section-title {
            color: var(--accent-text-light);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Specific text colors for P&L based on theme */
        .text-emerald-400 { color: var(--green-text); }
        .text-red-400 { color: var(--red-text); }
        .text-indigo-400 { color: var(--accent-text-light); }
        .text-indigo-300 { color: var(--accent-text-light); }
        .text-indigo-200 { color: color-mix(in srgb, var(--accent-text-light) 80%, var(--body-text) 20%); }

        /* --- USER PROVIDED STYLES --- */

        /* Quote Container Styles */
        .quote-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            background: linear-gradient(145deg, var(--card), color-mix(in srgb, var(--card) 80%, black));
            border-radius: 12px;
            box-shadow:
                0 5px 15px rgba(0, 0, 0, 0.2),
                inset 0 0 10px rgba(0, 0, 0, 0.1);
            transform: perspective(500px) rotateX(0deg);
            position: relative;
            transition: all 0.4s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            animation: float 6s ease-in-out infinite;
            flex-grow: 1;
            margin-left: 1rem;
            margin-right: 1rem;
        }

        @keyframes float {
            0%, 100% {
                transform: perspective(500px) rotateX(0deg) translateY(0);
            }
            50% {
                transform: perspective(500px) rotateX(2deg) translateY(-5px);
            }
        }

        .quote-container:hover {
            animation: none;
            transform: perspective(500px) rotateX(2deg) translateY(-2px);
        }

        .quote-text {
            font-size: 1.1rem;
            line-height: 1.5;
            font-style: italic;
            position: relative;
            z-index: 2;
            margin: 0;
            text-align: center;
            color: var(--text);
        }

        .quote-author {
            display: block;
            margin-top: 0.5rem;
            text-align: right;
            font-weight: 600;
            color: var(--gold-primary);
            font-size: 0.85rem;
        }

        /* Header Styles */
        .header-main-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            position: relative;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .header-main-section::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4361ee, #3a0ca3, #7209b7);
            filter: blur(4px);
        }

        .datetime-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            text-align: right;
            flex-shrink: 0;
        }

        .datetime-item {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text);
        }

        .datetime-label {
            font-weight: 600;
            color: var(--gold-secondary);
        }

        /* Footer Styles */
        .app-footer {
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
            color: var(--text);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            width: 100%;
        }

        .app-footer a {
            color: var(--accent);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .app-footer a:hover {
            color: var(--gold-primary);
            text-decoration: underline;
        }

        /* Autocomplete styles */
        .autocomplete-suggestions {
            position: absolute;
            background-color: var(--input-group-bg);
            border: 1px solid var(--border-color);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            width: calc(100% - 3.5rem);
            left: 3rem;
            border-radius: 0.375rem;
            top: 100%;
            margin-top: 4px;
        }

        .autocomplete-suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            color: var(--input-text);
            font-size: 0.95rem;
        }

        .autocomplete-suggestion-item:hover {
            background-color: var(--neutral-bg-hover);
        }

        .autocomplete-suggestion-item.active {
            background-color: var(--accent-primary);
            color: white;
        }

        /* Sidebar Specific Styles - Force Dark Theme */
        aside#sidebar {
            background-color: #1f2937; /* Fixed dark background */
            color: #c9d1d9; /* Fixed light text color */
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            z-index: 50;
            transform: translateX(0);
            transition: width 0.3s ease, transform 0.3s ease;
            border-right: 1px solid #4a5568; /* Dark border */
        }

        aside#sidebar .header-logo {
            color: #c9d1d9; /* Ensure logo text is light */
        }

        aside#sidebar .sidebar-text {
            color: #c9d1d9; /* Ensure all sidebar text is light */
        }

        aside#sidebar .hover\:bg-gray-700:hover {
            background-color: #3730a3; /* Darker indigo hover */
            color: #ffffff; /* White text on hover */
        }

        aside#sidebar .hover\:bg-gray-700:hover span,
        aside#sidebar .hover\:bg-gray-700:hover i {
            color: #ffffff; /* Ensure icon color changes on hover */
        }

        aside#sidebar .bg-indigo-700 {
            background-color: #4338ca; /* Active link background - fixed indigo */
            color: #ffffff; /* Active link text - fixed white */
        }

        aside#sidebar .bg-indigo-700 span,
        aside#sidebar .bg-indigo-700 i {
            color: #ffffff; /* Active link icon - fixed white */
        }

        aside#sidebar #theme-toggle {
            background-color: #2d3748; /* Dark background for toggle button */
            color: #c9d1d9; /* Light text for toggle button */
        }
        aside#sidebar #theme-toggle:hover {
            background-color: #1f2937; /* Darker hover for toggle button */
        }


        aside#sidebar.collapsed {
            width: 70px;
        }

        aside#sidebar.collapsed .sidebar-text {
            display: none;
        }

        aside#sidebar.collapsed .header-logo i {
            margin-right: 0;
        }

        aside#sidebar.collapsed .header-logo span {
            display: none;
        }

        aside#sidebar.collapsed .sidebar-link-content {
            justify-content: center;
        }

        aside#sidebar.collapsed #theme-toggle span {
            display: none;
        }

        aside#sidebar.collapsed #theme-toggle i {
            margin-right: 0;
        }

        /* Mobile Specific: Hide sidebar by default on mobile, show on toggle */
        @media (max-width: 768px) {
            aside#sidebar {
                transform: translateX(-100%);
                width: 200px;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
            }
            aside#sidebar.active {
                transform: translateX(0%);
            }
            #main-content {
                margin-left: 0;
            }
            #menu-toggle {
                display: block;
            }
        }

        /* Adjust main content to make space for the sidebar on desktop */
        #main-content {
            margin-left: 250px;
            flex: 1;
            transition: margin-left 0.3s ease;
        }

        #main-content.sidebar-collapsed {
            margin-left: 70px;
        }

        @media (max-width: 768px) {
            #main-content {
                margin-left: 0;
            }
        }

        /* Styles for editable table cells */
        .editable-cell {
            min-width: 80px;
            padding: 0.5rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            transition: border-color 0.2s ease;
            color: var(--body-text);
        }
        .editable-cell:focus {
            border-color: var(--accent-primary);
            outline: none;
            background-color: var(--input-group-bg);
        }
        .editable-cell.input-cell {
            background-color: var(--input-group-bg);
            border-color: var(--border-color);
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
            box-sizing: border-box;
        }
        .editable-cell.input-cell:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 50%, transparent);
        }

        /* === SCAN MODE TOGGLE BUTTON STYLES === */
        .scan-mode-toggle {
            background: var(--btn-toggle-bg);
            color: var(--btn-toggle-text);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-weight: 500;
            transition: all 0.3s ease;
            margin-left: 1rem;
            white-space: nowrap;
            width: auto;
        }
        .scan-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px color-mix(in srgb, var(--accent-primary) 30%, transparent);
        }
        /* Active state for scan mode button - now uses gradient */
        .scan-mode-toggle.active {
            background: linear-gradient(135deg, var(--accent-primary), color-mix(in srgb, var(--accent-primary) 80%, purple));
            color: white;
            box-shadow: 0 4px 20px color-mix(in srgb, var(--accent-primary) 40%, transparent);
            border-color: var(--accent-primary);
        }
        .scan-icon {
            font-size: 1.2em;
        }

        /* Styling for symbol cells when scan mode is active */
        .scan-mode-active-symbol {
            background: linear-gradient(45deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: background 0.3s ease, border-color 0.3s ease;
            cursor: help;
        }
        .scan-mode-active-symbol:hover {
            background: linear-gradient(45deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden flex-col">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gray-800 text-gray-300 p-4 flex flex-col justify-between rounded-r-xl shadow-lg transition-all duration-300 ease-in-out">
        <div>
            <div class="header-logo mb-6 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="line-chart" class="mr-2"></i> <span class="sidebar-text">NerdyTrades</span>
                </div>
                <button id="sidebar-toggle" class="p-1 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <i data-lucide="chevron-left" class="sidebar-toggle-icon"></i>
                </button>
            </div>
            <nav>
                <ul class="space-y-3">
                    <li>
                        <a href="#" id="nav-dashboard" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="layout-dashboard" class="mr-2"></i> <span class="sidebar-text">Dashboard</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-add-trade" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="plus-circle" class="mr-2"></i> <span class="sidebar-text">Add Trade</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-view-trades" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="clipboard-list" class="mr-2"></i> <span class="sidebar-text">View Trades</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-analytics" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="bar-chart-2" class="mr-2"></i> <span class="sidebar-text">Advanced Analytics</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-reflections" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="book-open" class="mr-2"></i> <span class="sidebar-text">Reflections</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="https://raghutrades.github.io/Nerdy-HolisticProcess/" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="compass" class="mr-2"></i> <span class="sidebar-text">Holistic Process</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-lot-size-calculator" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="calculator" class="mr-2"></i> <span class="sidebar-text">Sectors HawkView 🦅</span>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="nav-settings" class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 text-sm">
                            <div class="flex items-center sidebar-link-content">
                                <i data-lucide="settings" class="mr-2"></i> <span class="sidebar-text">Settings</span>
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="mt-6">
            <button id="theme-toggle" class="w-full flex items-center justify-center p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200 text-white text-sm">
                <i data-lucide="sun-moon" class="mr-2"></i> <span class="sidebar-text">Toggle Theme</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-1 p-6 transition-all duration-300 ease-in-out flex flex-col overflow-y-auto">
        <!-- Mobile Menu Toggle Button -->
        <button id="menu-toggle" class="md:hidden p-2 rounded-lg bg-gray-700 text-white mb-4 text-sm self-start">
            <i data-lucide="menu"></i>
        </button>

        <!-- Consolidated Header Section: Quote, Datetime -->
        <div class="header-main-section">
            <!-- Quote Container -->
            <div class="quote-container">
                <p class="quote-text" id="quoteText">"The market is a device for transferring money from the impatient to the patient."</p>
                <span class="quote-author" id="quoteAuthor">- Warren Buffett</span>
            </div>
            <!-- Datetime Container -->
            <div class="flex flex-col items-end ml-4">
                <div class="datetime-container">
                    <div class="datetime-item">
                        <span class="datetime-label">Date:</span>
                        <span id="current-date">Loading...</span>
                    </div>
                    <div class="datetime-item">
                        <span class="datetime-label">Time:</span>
                        <span id="current-time">Loading...</span>
                    </div>
                    <div class="datetime-item">
                        <span class="datetime-label">Remaining in Month:</span>
                        <span id="days-month">Loading...</span>
                    </div>
                    <div class="datetime-item">
                        <span class="datetime-label">Remaining in Year:</span>
                        <span id="days-year">Loading...</span>
                    </div>
                </div>
            </div>
        </div>


        <!-- Dynamic Content Area -->
        <div id="app-content" class="flex-1">
            <!-- Content will be loaded here dynamically -->
        </div>

        <!-- Custom Message Box Modal -->
        <div id="message-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close-button" id="message-close-button">&times;</span>
                <h3 id="message-title" class="text-xl font-semibold mb-4 text-indigo-400"></h3>
                <p id="message-text" class="text-zinc-300"></p>
                <div class="mt-6 flex justify-end">
                    <button id="message-ok-button" class="btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer with Social Handles -->
    <div class="app-footer">
        Developed by ❤️ <a href="https://www.instagram.com/nerdyintruder/" target="_blank">@Nerdyintruder</a>
    </div>

    <script>
    // Register Chart.js Data Labels Plugin
    Chart.register(ChartDataLabels);
    

    // --- Global Variables and Constants ---
    const DB_NAME = 'TradingJournalDB';
    const DB_VERSION = 2; // Current DB version
    const STORE_TRADES = 'trades';
    const STORE_REFLECTIONS = 'reflections'; // New IndexedDB store for reflections

    let db; // IndexedDB instance

    // User-provided quotes data
    const quotesData = [
        { text: "Opportunities don't happen, you create them.", author: "" },
        { text: "The market is always right. Never argue with it.", author: "" },
        { text: "Price is what you pay. Value is what you get.", author: "Benjamin Graham" },
        { text: "The stock market is a device for transferring money from the impatient to the patient.", author: "Warren Buffett" },
        { text: "Rule No. 1: Never lose money. Rule No. 2: Never forget Rule No. 1.", author: "Warren Buffett" },
        { text: "The four most dangerous words in investing are: 'This time it's different.'", author: "Sir John Templeton" },
        { text: "Successful trading is not about being right, it's about making money when you are right and losing less when you are wrong.", author: "Unknown" },
        { text: "The market has a way of humbling even the most arrogant.", author: "Unknown" },
        { text: "Amateurs think about how much money they can make. Professionals think about how much they can lose.", author: "Jack Schwager" },
        { text: "Don't tell me what you 'think' about the market. Tell me what you 'know' with your positions.", author: "Mark Douglas" },
        { text: "Every position you take involves risk. If you can't handle the risk, don't take the position.", author: "Unknown" },
        { text: "The goal is not to trade often, but to trade well.", author: "Unknown" },
        { text: "Trading is a marathon, not a sprint. Consistency is key.", author: "Unknown" },
        { text: "Cut your losses short, let your winners run.", author: "Jesse Livermore" },
        { text: "The biggest enemy of a good plan is the dream of a perfect plan.", author: "Carl von Clausewitz" },
        { text: "Fear and greed are the two most powerful emotions in the market.", author: "Unknown" },
        { text: "The market doesn't care about your opinions.", author: "Unknown" },
        { text: "Do more of what works, less of what doesn't.", author: "Unknown" },
        { text: "The trend is your friend, until it bends.", author: "Unknown" },
        { text: "Patience is a virtue in trading.", author: "Unknown" },
        { text: "It's not about catching tops or bottoms, but about catching the middle.", author: "Unknown" },
        { text: "The price of success is hard work, dedication to the job at hand, and the determination that whether we win or lose, we have applied the best of ourselves to the task at hand.", author: "Vince Lombardi" },
        { text: "The more you learn, the more you earn.", author: "Warren Buffett" },
        { text: "Trading is 80% psychology, 20% methodology.", author: "Unknown" },
        { text: "Focus on risk management, not just profits.", author: "Unknown" },
        { text: "Never risk more than you can afford to lose.", author: "Unknown" },
        { text: "A disciplined trader always follows his plan.", author: "Unknown" },
        { text: "Learn from your mistakes, but don't dwell on them.", author: "Unknown" },
        { text: "The market is always right.", author: "Unknown" },
        { text: "Trade what you see, not what you think.", author: "Unknown" },
        { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
        { text: "The secret to success is to know something nobody else knows.", author: "Aristotle Onassis" },
        { text: "Opportunities come infrequently. When it rains gold, put out the bucket, not the thimble.", author: "Warren Buffett" },
        { text: "It takes courage to be a market leader.", author: "Paul Tudor Jones" },
        { text: "There is a time for patience and a time for action.", author: "Unknown" },
        { text: "Consistency over intensity.", author: "Unknown" },
        { text: "The purpose of a trading plan is to provide a road map for consistent action.", author: "Unknown" },
        { text: "Don't chase the market. Let the market come to you.", author: "Unknown" },
        { text: "The hardest money to make is money you need.", author: "Unknown" },
        { text: "Trading is about controlling your emotions.", author: "Unknown" },
        { text: "The journey of a thousand miles begins with a single step.", author: "Lao Tzu" },
        { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
        { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
        { text: "The best revenge is massive success.", author: "Frank Sinatra" },
        { text: "Perfection is not attainable, but if we chase perfection we can catch excellence.", author: "Vince Lombardi" },
        { text: "Your attitude, not your aptitude, will determine your altitude.", author: "Zig Ziglar" },
        { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
        { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
        { text: "The mind is everything. What you think you become.", author: "Buddha" },
        { text: "Eighty percent of success is showing up.", author: "Woody Allen" },
        { text: "Winning isn't everything, but wanting to win is.", author: "Vince Lombardi" },
        { text: "Great minds discuss ideas; average minds discuss events; small minds discuss people.", author: "Eleanor Roosevelt" },
        { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
        { text: "The greatest glory in living lies not in never falling, but in rising every time we fall. - Nelson Mandela", author: "Nelson Mandela" },
        { text: "You miss 100% of the shots you don't take.", author: "Wayne Gretzky" },
        { text: "The best way to predict the future is to create it.", author: "Peter Drucker" },
        { text: "If you want to lift yourself up, lift up someone else.", author: "Booker T. Washington" },
        { text: "Action is the foundational key to all success.", author: "Pablo Picasso" },
        { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
        { text: "The difference between a successful person and others is not a lack of strength, not a lack of knowledge, but rather a lack of will.", author: "Vince Lombardi" },
        { text: "The only place where success comes before work is in the dictionary.", author: "Vidal Sassoon" },
        { text: "The road to success and the road to failure are almost exactly the same.", author: "Colin R. Davis" },
        { text: "Opportunities don't happen, you create them.", author: "Chris Grosser" },
        { text: "To be successful, you must accept all challenges that come your way. You can't just accept the ones you like.", author: "Mike Gafka" },
        { text: "What seems to us as bitter trials are often blessings in disguise.", author: "Oscar Wilde" },
        { text: "The most difficult thing is the decision to act, the rest is merely tenacity.", author: "Amelia Earhart" },
        { text: "It is during our darkest moments that we must focus to see the light.", author: "Aristotle" },
        { text: "There is only one way to avoid criticism: do nothing, say nothing, and be nothing.", author: "Aristotle" },
        { text: "The only person you are destined to become is the person you decide to be.", author: "Ralph Waldo Emerson" },
        { text: "When you cease to dream, you cease to live.", author: "Malcolm Forbes" },
        { text: "The best way to gain self-confidence is to do what you are afraid to do.", author: "Swati Sharma" },
        { text: "The greatest discovery of all time is that a person can change his future by merely changing his attitude.", author: "Oprah Winfrey" },
        { text: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", author: "Aristotle" },
        { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
        { text: "The mind is a powerful thing. It can make you into whatever you want to be.", author: "Unknown" },
        { text: "If you have integrity, nothing else matters. If you don't have integrity, nothing else matters.", author: "Harvey MacKay" },
        { text: "The only true wisdom is in knowing you know nothing.", author: "Socrates" },
        { text: "The unexamined life is not worth living.", author: "Socrates" },
        { text: "Where there is a will, there is a way.", author: "Unknown" },
        { text: "The power of imagination makes us infinite.", author: "John Muir" },
        { text: "Life is 10% what happens to us and 90% how we react to it.", author: "Charles R. Swindoll" },
        { text: "If you want to live a happy life, tie it to a goal, not to people or things.", author: "Albert Einstein" },
        { text: "Never give up on a dream just because of the time it will take to accomplish it. The time will pass anyway.", author: "Earl Nightingale" },
        { text: "The only thing worse than starting something and failing... is not starting something.", author: "Seth Godin" },
        { text: "The best way to find yourself is to lose yourself in the service of others.", author: "Mahatma Gandhi" },
        { text: "If you are not willing to risk the usual, you will have to settle for the ordinary.", author: "Jim Rohn" },
        { text: "Success is not the key to happiness. Happiness is the key to success. If you love what you are doing, you will be successful.", author: "Albert Schweitzer" },
        { text: "The only impossible journey is the one you never begin.", author: "Tony Robbins" },
        { text: "In three words I can sum up everything I've learned about life: it goes on.", author: "Robert Frost" },
        { text: "The future belongs to those who prepare for it today.", author: "Malcolm X" },
        { text: "It is better to fail in originality than to succeed in imitation.", author: "Herman Melville" },
        { text: "The mind is not a vessel to be filled, but a fire to be kindled.", author: "Plutarch" },
        { text: "Nothing is impossible, the word itself says 'I'm possible'!", author: "Audrey Hepburn" },
        { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" },
        { text: "The biggest risk is not taking any risk. In a world that's changing really quickly, the only strategy that is guaranteed to fail is not taking risks.", author: "Mark Zuckerberg" },
        { text: "Challenges are what make life interesting and overcoming them is what makes life meaningful.", author: "Joshua J. Marine" },
        { text: "The only way to do great work is to love what you do. If you haven't found it yet, keep looking. Don't settle.", author: "Steve Jobs" },
        { text: "The greatest education in the world is watching the masters at work.", author: "Michael Jackson" },
        { text: "The journey of a thousand miles begins with a single step.", author: "Lao Tzu" },
        { text: "Your time is limited, so don't waste it living someone else's life.", author: "Steve Jobs" },
        { text: "Innovation distinguishes between a leader and a follower.", author: "Steve Jobs" }
    ];

    // Define the specific sectors from the F&O HawkView script for the dropdown
    // This list will be used to populate the sector filter dropdown.
    const FOHAWKVIEW_SECTORS = [
        "NIFTY 50", "NIFTY AUTO", "NIFTY BANK", "NIFTY CEMEN",
        "NIFTY ConDUR", "NIFTY CONSUMP", "NIFTY ENERGY", "NIFTY FINS",
        "NIFTY FMCG", "NIFTY HEALTH", "NIFTY INFRA", "NIFTY ITech",
        "NIFTY MEDIA", "NIFTY METAL", "NIFTY MIDCAP 50", "NIFTY NEXT 50",
        "NIFTY O--GAS", "NIFTY PBANK", "NIFTY PHARMA", "NIFTY PSU-B",
        "NIFTY REALTY", "NIFTY SMALLCAP 50"
    ].sort(); // Sort them alphabetically


    // Consolidated INSTRUMENTS_AND_LOT_SIZES from the F&O HawkView script
    // Modified to allow stocks to belong to multiple sectors
    const INSTRUMENTS_AND_LOT_SIZES = (function() {
        const existingLotSizes = new Map([
            ["BANKNIFTY", 35], ["FINNIFTY", 65], ["MIDCPNIFTY", 140], ["NIFTY", 75], ["NIFTY NEXT 50", 25],
            ["360ONE", 500], ["AARTIIND", 1325], ["ABB", 125], ["ABCAPITAL", 3100], ["ABFRL", 2600],
            ["ACC", 300], ["ADANIENSOL", 675], ["ADANIENT", 300], ["ADANIGREEN", 600], ["ADANIPOWER", 2500], ["ADANIPORTS", 475], ["ADANINEOSL", 1000],
            ["ALKEM", 125], ["AMBER", 100], ["AMBUJACEM", 1050], ["ANGELONE", 250], ["APLAPOLLO", 350],
            ["APOLLOHOSP", 125], ["ASHOKLEY", 5000], ["ASIANPAINT", 250], ["ASTRAL", 425], ["ATGL", 875],
            ["AUBANK", 1000], ["AUROPHARMA", 550], ["AXISBANK", 625], ["BAJAJ-AUTO", 75], ["BAJAJFINSV", 500],
            ["BAJFINANCE", 750], ["BALKRISIND", 300], ["BANDHANBNK", 3600], ["BANKBARODA", 2925], ["BANKINDIA", 5200],
            ["BDL", 325], ["BEL", 2850], ["BHARATFORG", 500], ["BHARTIARTL", 475], ["BHEL", 2625],
            ["BIOCON", 2500], ["BLUESTARCO", 325], ["BOSCHLTD", 25], ["BPCL", 1975], ["BRITANNIA", 125],
            ["BSE", 375], ["BSOFT", 1300], ["CAMS", 150], ["CANBK", 6750], ["CDSL", 475],
            ["CESC", 3625], ["CGPOWER", 850], ["CHAMBLFERT", 950], ["CHOLAFIN", 625], ["CIPLA", 375],
            ["COALINDIA", 1350], ["COFORGE", 375], ["COLPAL", 225], ["CONCOR", 1250], ["CROMPTON", 1800],
            ["CUMMINSIND", 200], ["CYIENT", 425], ["DABUR", 1250], ["DALBHARAT", 325], ["DELHIVERY", 2075],
            ["DIVISLAB", 100], ["DIXON", 50], ["DLF", 825], ["DMART", 150], ["DRREDDY", 625],
            ["EICHERMOT", 175], ["ETERNAL", 2425], ["EXIDEIND", 1800], ["FEDERALBNK", 5000], ["FORTIS", 775],
            ["GAIL", 3150], ["GLENMARK", 375], ["GMRAIRPORT", 6975], ["GODREJCP", 500], ["GODREJPROP", 275],
            ["GRANULES", 1075], ["GRASIM", 250], ["HAL", 150], ["HAVELLS", 500], ["HCLTECH", 350],
            ["HDFCAMC", 150], ["HDFCBANK", 550], ["HDFCLIFE", 1100], ["HEROMOTOCO", 150], ["HFCL", 6450],
            ["HINDALCO", 1400], ["HINDCOPPER", 2650], ["HINDPETRO", 2025], ["HINDUNILVR", 300], ["HINDZINC", 1225],
            ["HUDCO", 2775], ["ICICIBANK", 700], ["ICICIGI", 325], ["ICICIPRULI", 925], ["IDEA", 71475],
            ["IDFCFIRSTB", 9275], ["IEX", 3750], ["IGL", 2750], ["IIFL", 1650], ["INDHOTEL", 1000],
            ["INDIANB", 1000], ["INDIGO", 150], ["INDUSINDBK", 700], ["INDUSTOWER", 1700], ["INFY", 400],
            ["INOXWIND", 3225], ["IOC", 4875], ["IRB", 11675], ["IRCTC", 875], ["IREDA", 3450],
            ["IRFC", 4250], ["ITC", 1600], ["JINDALSTEL", 625], ["JIOFIN", 2350], ["JSL", 850],
            ["JSWENERGY", 1000], ["JSWSTEEL", 675], ["JUBLFOOD", 1250], ["KALYANKJIL", 1175], ["KAYNES", 100],
            ["KEI", 175], ["KFINTECH", 450], ["KOTAKBANK", 400], ["KPITTECH", 400], ["LAURUSLABS", 1700],
            ["LICHSGFIN", 1000], ["LICI", 700], ["LODHA", 450], ["LT", 175], ["LTF", 4462],
            ["LTIM", 150], ["LUPIN", 425], ["M&M", 200], ["M&MFIN", 2056], ["MANAPPURAM", 3000],
            ["MANKIND", 225], ["MARICO", 1200], ["MARUTI", 50], ["MAXHEALTH", 525], ["MAZDOCK", 175],
            ["MCX", 125], ["MFSL", 800], ["MGL", 400], ["MOTHERSON", 6150], ["MPHASIS", 275],
            ["MUTHOOTFIN", 275], ["NATIONALUM", 3750], ["NAUKRI", 375], ["NBCC", 6500], ["NCC", 2700],
            ["NESTLEIND", 250], ["NHPC", 6400], ["NMDC", 13500], ["NTPC", 1500], ["NUVAMA", 200], ["NYKAA", 3125],
            ["OBEROIRLTY", 350], ["OFSS", 75], ["OIL", 1400], ["ONGC", 2250], ["PAGEIND", 15],
            ["PATANJALI", 300], ["PAYTM", 725], ["PEL", 750], ["PERSISTENT", 100], ["PETRONET", 1800],
            ["PFC", 1300], ["PGEL", 700], ["PHOENIXLTD", 350], ["PIDILITIND", 250], ["PIIND", 175],
            ["PNB", 8000], ["PNBHOUSING", 650], ["POLICYBZR", 350], ["POLYCAB", 125], ["POONAWALLA", 1700],
            ["POWERGRID", 1900], ["PPLPHARMA", 2500], ["PRESTIGE", 450], ["RBLBANK", 3175], ["REC", 1275],
            ["RELIANCE", 500], ["RVNL", 1375], ["SAIL", 4700], ["SBICARD", 800], ["SBILIFE", 375],
            ["SBIN", 750], ["SHREECEM", 25], ["SHRIRAMFIN", 825], ["SIEMENS", 125], ["SJVN", 5875],
            ["SOLARINDS", 75], ["SONACOMS", 1050], ["SRF", 200], ["SUNPHARMA", 350], ["SUPREMEIND", 175],
            ["SUZLON", 10000], ["SWIGGY", 1], // Placeholder for SWIGGY, assuming lot size 1
            ["SYNGENE", 1000], ["TATACHEM", 650], ["TATACOMM", 350], ["TATACONSUM", 550], ["TATAELXSI", 100],
            ["TATAMOTORS", 800], ["TATAPOWER", 1450], ["TATASTEEL", 5500], ["TATATECH", 800], ["TCS", 175],
            ["TECHM", 600], ["TEJASNET", 3000], ["TIINDIA", 200], ["TITAGARH", 725], ["TITAN", 175],
            ["TORNTPHARM", 250], ["TORNTPOWER", 375], ["TRENT", 100], ["TVSMOTOR", 350], ["ULTRACEMCO", 50], ["UNIONBANK", 4425],
            ["UNITDSPR", 400], ["UNOMINDA", 550], ["UPL", 1355], ["VBL", 1025], ["VEDL", 1150],
            ["VOLTAS", 375], ["WIPRO", 3000], ["YESBANK", 31100], ["ZYDUSLIFE", 900]
        ]);

        const hawkViewStocksMap = new Map(); // Use a Map to easily update existing entries

        // Helper to add/update stock with its sectors
        function addStock(company, symbol, sector) {
            let stock = hawkViewStocksMap.get(symbol);
            if (!stock) {
                stock = {
                    company: company,
                    symbol: symbol,
                    lotSize: existingLotSizes.get(symbol) || 1, // Default to 1 if not found
                    sectors: [] // Initialize as an array
                };
                hawkViewStocksMap.set(symbol, stock);
            }
            if (!stock.sectors.includes(sector)) {
                stock.sectors.push(sector); // Add sector if not already present
            }
        }

        // Nifty 50 Constituents (Combined from part1 and part2)
        [
            { company: "ADANIENT", symbol: "ADANIENT" }, { company: "ADANIPORTS", symbol: "ADANIPORTS" },
            { company: "APOLLOHOSP", symbol: "APOLLOHOSP" }, { company: "ASIANPAINT", symbol: "ASIANPAINT" },
            { company: "AXISBANK", symbol: "AXISBANK" }, { company: "BAJAJ-AUTO", symbol: "BAJAJ-AUTO" },
            { company: "BAJFINANCE", symbol: "BAJFINANCE" }, { company: "BAJAJFINSV", symbol: "BAJAJFINSV" },
            { company: "BPCL", symbol: "BPCL" }, { company: "BHARTIARTL", symbol: "BHARTIARTL" },
            { company: "BRITANNIA", symbol: "BRITANNIA" }, { company: "CIPLA", symbol: "CIPLA" },
            { company: "COALINDIA", symbol: "COALINDIA" }, { company: "DIVISLAB", symbol: "DIVISLAB" },
            { company: "DRREDDY", symbol: "DRREDDY" }, { company: "EICHERMOT", symbol: "EICHERMOT" },
            { company: "GRASIM", symbol: "GRASIM" }, { company: "HCLTECH", symbol: "HCLTECH" },
            { company: "HDFCBANK", symbol: "HDFCBANK" }, { company: "HDFCLIFE", symbol: "HDFCLIFE" },
            { company: "HEROMOTOCO", symbol: "HEROMOTOCO" }, { company: "HINDALCO", symbol: "HINDALCO" },
            { company: "HINDUNILVR", symbol: "HINDUNILVR" }, { company: "ICICIBANK", symbol: "ICICIBANK" },
            { company: "ITC", symbol: "ITC" }, { company: "INDUSINDBK", symbol: "INDUSINDBK" },
            { company: "INFY", symbol: "INFY" }, { company: "JSWSTEEL", symbol: "JSWSTEEL" },
            { company: "KOTAKBANK", symbol: "KOTAKBANK" }, { company: "LTIM", symbol: "LTIM" },
            { company: "LT", symbol: "LT" }, { company: "M&M", symbol: "M&M" },
            { company: "MARUTI", symbol: "MARUTI" }, { company: "NTPC", symbol: "NTPC" },
            { company: "NESTLEIND", symbol: "NESTLEIND" }, { company: "ONGC", symbol: "ONGC" },
            { company: "POWERGRID", symbol: "POWERGRID" }, { company: "RELIANCE", symbol: "RELIANCE" },
            { company: "SBILIFE", symbol: "SBILIFE" }, { company: "SBIN", symbol: "SBIN" },
            { company: "SUNPHARMA", symbol: "SUNPHARMA" }, { company: "TATACONSUM", symbol: "TATACONSUM" },
            { company: "TATAMOTORS", symbol: "TATAMOTORS" }, { company: "TATASTEEL", symbol: "TATASTEEL" },
            { company: "TECHM", symbol: "TECHM" }, { company: "TITAN", symbol: "TITAN" },
            { company: "TCS", symbol: "TCS" }, { company: "UPL", symbol: "UPL" },
            { company: "ULTRACEMCO", symbol: "ULTRACEMCO" }, { company: "WIPRO", symbol: "WIPRO" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY 50"));

        // Bank (Combined from Bank and Private Bank)
        [
            { company: "AUBANK", symbol: "AUBANK" }, { company: "AXISBANK", symbol: "AXISBANK" },
            { company: "BANDHANBNK", symbol: "BANDHANBNK" }, { company: "BANKBARODA", symbol: "BANKBARODA" },
            { company: "BANKINDIA", symbol: "BANKINDIA" }, { company: "CANBK", symbol: "CANBK" },
            { company: "FEDERALBNK", symbol: "FEDERALBNK" }, { company: "HDFCBANK", symbol: "HDFCBANK" },
            { company: "ICICIBANK", symbol: "ICICIBANK" }, { company: "IDFCFIRSTB", symbol: "IDFCFIRSTB" },
            { company: "INDUSINDBK", symbol: "INDUSINDBK" }, { company: "KOTAKBANK", symbol: "KOTAKBANK" },
            { company: "PNB", symbol: "PNB" }, { company: "RBLBANK", symbol: "RBLBANK" },
            { company: "SBIN", symbol: "SBIN" }, { company: "UNIONBANK", symbol: "UNIONBANK" },
            { company: "YESBANK", symbol: "YESBANK" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY BANK"));

        // Pharma
        [
            { company: "ALKEM", symbol: "ALKEM" }, { company: "AUROPHARMA", symbol: "AUROPHARMA" },
            { company: "BIOCON", symbol: "BIOCON" }, { company: "CIPLA", symbol: "CIPLA" },
            { company: "DIVISLAB", symbol: "DIVISLAB" }, { company: "DRREDDY", symbol: "DRREDDY" },
            { company: "GLENMARK", symbol: "GLENMARK" }, { company: "GRANULES", symbol: "GRANULES" },
            { company: "LAURUSLABS", symbol: "LAURUSLABS" }, { company: "LUPIN", symbol: "LUPIN" },
            { company: "MANKIND", symbol: "MANKIND" }, { company: "PPLPHARMA", symbol: "PPLPHARMA" },
            { company: "SUNPHARMA", symbol: "SUNPHARMA" }, { company: "TORNTPHARM", symbol: "TORNTPHARM" },
            { company: "ZYDUSLIFE", symbol: "ZYDUSLIFE" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY PHARMA"));

        // Metal
        [
            { company: "ADANIENT", symbol: "ADANIENT" }, { company: "APLAPOLLO", symbol: "APLAPOLLO" },
            { company: "HINDALCO", symbol: "HINDALCO" }, { company: "HINDCOPPER", symbol: "HINDCOPPER" },
            { company: "HINDZINC", symbol: "HINDZINC" }, { company: "JINDALSTEL", symbol: "JINDALSTEL" },
            { company: "JSL", symbol: "JSL" }, { company: "JSWSTEEL", symbol: "JSWSTEEL" },
            { company: "NATIONALUM", symbol: "NATIONALUM" }, { company: "NMDC", symbol: "NMDC" },
            { company: "SAIL", symbol: "SAIL" }, { company: "TATASTEEL", symbol: "TATASTEEL" },
            { company: "VEDL", symbol: "VEDL" }, { company: "TATACHEM", symbol: "TATACHEM" } // Added TATACHEM
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY METAL"));

        // IT
        [
            { company: "COFORGE", symbol: "COFORGE" }, { company: "PERSISTENT", symbol: "PERSISTENT" },
            { company: "MPHASIS", symbol: "MPHASIS" }, { company: "TCS", symbol: "TCS" },
            { company: "OFSS", symbol: "OFSS" }, { company: "HCLTECH", symbol: "HCLTECH" },
            { company: "LTIM", symbol: "LTIM" }, { company: "WIPRO", symbol: "WIPRO" },
            { company: "TECHM", symbol: "TECHM" }, { company: "INFY", symbol: "INFY" },
            { company: "KPITTECH", symbol: "KPITTECH" }, // Added KPITTECH
            { company: "TATATECH", symbol: "TATATECH" }, // Added TATATECH
            { company: "TATAELXSI", symbol: "TATAELXSI" } // Added TATAELXSI
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY ITech"));

        // FMCG
        [
            { company: "BRITANNIA", symbol: "BRITANNIA" }, { company: "COLPAL", symbol: "COLPAL" },
            { company: "DABUR", symbol: "DABUR" }, { company: "GODREJCP", symbol: "GODREJCP" },
            { company: "HINDUNILVR", symbol: "HINDUNILVR" }, { company: "ITC", symbol: "ITC" },
            { company: "MARICO", symbol: "MARICO" }, { company: "NESTLEIND", symbol: "NESTLEIND" },
            { company: "PATANJALI", symbol: "PATANJALI" }, { company: "TATACONSUM", symbol: "TATACONSUM" },
            { company: "UNITDSPR", symbol: "UNITDSPR" }, { company: "VBL", symbol: "VBL" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY FMCG"));

        // Auto
        [
            { company: "ASHOKLEY", symbol: "ASHOKLEY" }, { company: "BAJAJ-AUTO", symbol: "BAJAJ-AUTO" },
            { company: "BALKRISIND", symbol: "BALKRISIND" }, { company: "BHARATFORG", symbol: "BHARATFORG" },
            { company: "BOSCHLTD", symbol: "BOSCHLTD" }, { company: "EICHERMOT", symbol: "EICHERMOT" },
            { company: "EXIDEIND", symbol: "EXIDEIND" }, { company: "HEROMOTOCO", symbol: "HEROMOTOCO" },
            { company: "M&M", symbol: "M&M" }, { company: "MARUTI", symbol: "MARUTI" },
            { company: "MOTHERSON", symbol: "MOTHERSON" }, { company: "SONACOMS", symbol: "SONACOMS" },
            { company: "TATAMOTORS", symbol: "TATAMOTORS" }, { company: "TIINDIA", symbol: "TIINDIA" },
            { company: "TVSMOTOR", symbol: "TVSMOTOR" }, { company: "UNOMINDA", symbol: "UNOMINDA" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY AUTO"));

        // Financial Services (Combined from financial_services_stocks_part1, part2 and finsrv_25_50)
        [
            { company: "HDFCLIFE", symbol: "HDFCLIFE" }, { company: "ICICIBANK", symbol: "ICICIBANK" },
            { company: "ICICIGI", symbol: "ICICIGI" }, { company: "BAJFINANCE", symbol: "BAJFINANCE" },
            { company: "HDFCBANK", symbol: "HDFCBANK" }, { company: "SBILIFE", symbol: "SBILIFE" },
            { company: "AXISBANK", symbol: "AXISBANK" }, { company: "SBICARD", symbol: "SBICARD" },
            { company: "KOTAKBANK", symbol: "KOTAKBANK" }, { company: "MUTHOOTFIN", symbol: "MUTHOOTFIN" },
            { company: "HDFCAMC", symbol: "HDFCAMC" }, { company: "CHOLAFIN", symbol: "CHOLAFIN" },
            { company: "LICHSGFIN", symbol: "LICHSGFIN" }, { company: "BAJAJFINSV", symbol: "BAJAJFINSV" },
            { company: "SBIN", symbol: "SBIN" }, { company: "PFC", symbol: "PFC" },
            { company: "REC", symbol: "REC" }, { company: "ICICIPRULI", symbol: "ICICIPRULI" },
            { company: "JIOFIN", symbol: "JIOFIN" }, { company: "SHRIRAMFIN", symbol: "SHRIRAMFIN" },
            { company: "360ONE", symbol: "360ONE" }, // Added 360ONE
            { company: "ABCAPITAL", symbol: "ABCAPITAL" }, // Added ABCAPITAL
            { company: "ANGELONE", symbol: "ANGELONE" }, // Added ANGELONE
            { company: "CAMS", symbol: "CAMS" }, // Added CAMS
            { company: "CDSL", symbol: "CDSL" }, // Added CDSL
            { company: "IIFL", symbol: "IIFL" }, // Added IIFL
            { company: "IREDA", symbol: "IREDA" }, // Added IREDA
            { company: "KFINTECH", symbol: "KFINTECH" }, // Added KFINTECH
            { company: "LTF", symbol: "LTF" }, // Added LTF
            { company: "MANAPPURAM", symbol: "MANAPPURAM" }, // Added MANAPPURAM
            { company: "MCX", symbol: "MCX" }, // Added MCX
            { company: "MFSL", symbol: "MFSL" }, // Added MFSL
            { company: "NUVAMA", symbol: "NUVAMA" }, // Added NUVAMA
            { company: "PNBHOUSING", symbol: "PNBHOUSING" }, // Added PNBHOUSING
            { company: "POONAWALLA", symbol: "POONAWALLA" } // Added POONAWALLA
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY FINS"));

        // Realty
        [
            { company: "DLF", symbol: "DLF" }, { company: "GODREJPROP", symbol: "GODREJPROP" },
            { company: "LODHA", symbol: "LODHA" }, { company: "OBEROIRLTY", symbol: "OBEROIRLTY" },
            { company: "PHOENIXLTD", symbol: "PHOENIXLTD" }, { company: "PRESTIGE", symbol: "PRESTIGE" },
            { company: "NCC", symbol: "NCC" },          // New addition
            { company: "NBCC", symbol: "NBCC" }         // New addition
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY REALTY"));

        // Energy (Combined from energy_stocks_part1 and part2)
        [
            { company: "ABB", symbol: "ABB" }, { company: "BHEL", symbol: "BHEL" },
            { company: "BPCL", symbol: "BPCL" }, { company: "CESC", symbol: "CESC" },
            { company: "CGPOWER", symbol: "CGPOWER" }, { company: "GAIL", symbol: "GAIL" },
            { company: "HINDPETRO", symbol: "HINDPETRO" }, { company: "IGL", symbol: "IGL" },
            { company: "IOC", symbol: "IOC" }, { company: "JSWENERGY", symbol: "JSWENERGY" },
            { company: "MGL", symbol: "MGL" }, { company: "NHPC", symbol: "NHPC" },
            { company: "NTPC", symbol: "NTPC" }, { company: "OIL", symbol: "OIL" },
            { company: "ONGC", symbol: "ONGC" }, { company: "PETRONET", symbol: "PETRONET" },
            { company: "POWERGRID", symbol: "POWERGRID" }, { company: "RELIANCE", symbol: "RELIANCE" },
            { company: "SIEMENS", symbol: "SIEMENS" }, { company: "SJVN", symbol: "SJVN" },
            { company: "SOLARINDS", symbol: "SOLARINDS" }, { company: "TATAPOWER", symbol: "TATAPOWER" },
            { company: "TORNTPOWER", symbol: "TORNTPOWER" }, { company: "ADANIENSOL", symbol: "ADANIENSOL" },
            { company: "ADANIGREEN", symbol: "ADANIGREEN" }, { company: "ATGL", symbol: "ATGL" },
            { company: "INOXWIND", symbol: "INOXWIND" }, { company: "SUZLON", symbol: "SUZLON" } // Added SUZLON
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY ENERGY"));

        // Cement
        [
            { company: "ACC", symbol: "ACC" }, { company: "AMBUJACEM", symbol: "AMBUJACEM" },
            { company: "SHREECEM", symbol: "SHREECEM" }, { company: "ULTRACEMCO", symbol: "ULTRACEMCO" },
            { company: "DALBHARAT", symbol: "DALBHARAT" } // Added DALBHARAT
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY CEMEN"));

        // PSU Bank
        [
            { company: "BANKBARODA", symbol: "BANKBARODA" }, { company: "BANKINDIA", symbol: "BANKINDIA" },
            { company: "CANBK", symbol: "CANBK" }, { company: "INDIANB", symbol: "INDIANB" },
            { company: "PNB", symbol: "PNB" }, { company: "SBIN", symbol: "SBIN" },
            { company: "UNIONBANK", symbol: "UNIONBANK" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY PSU-B"));

        // Healthcare
        [
            { company: "ALKEM", symbol: "ALKEM" }, { company: "APOLLOHOSP", symbol: "APOLLOHOSP" },
            { company: "AUROPHARMA", symbol: "AUROPHARMA" }, { company: "BIOCON", symbol: "BIOCON" },
            { company: "CIPLA", symbol: "CIPLA" }, { company: "DIVISLAB", symbol: "DIVISLAB" },
            { company: "DRREDDY", symbol: "DRREDDY" }, { company: "FORTIS", symbol: "FORTIS" },
            { company: "GLENMARK", symbol: "GLENMARK" }, { company: "GRANULES", symbol: "GRANULES" },
            { company: "LAURUSLABS", symbol: "LAURUSLABS" }, { company: "LUPIN", symbol: "LUPIN" },
            { company: "MANKIND", symbol: "MANKIND" }, { company: "MAXHEALTH", symbol: "MAXHEALTH" },
            { company: "PPLPHARMA", symbol: "PPLPHARMA" }, { company: "SUNPHARMA", symbol: "SUNPHARMA" },
            { company: "SYNGENE", symbol: "SYNGENE" }, { company: "ZYDUSLIFE", symbol: "ZYDUSLIFE" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY HEALTH"));

        // Oil & Gas
        [
            { company: "ATGL", symbol: "ATGL" }, { company: "BPCL", symbol: "BPCL" },
            { company: "GAIL", symbol: "GAIL" }, { company: "HINDPETRO", symbol: "HINDPETRO" },
            { company: "IGL", symbol: "IGL" }, { company: "IOC", symbol: "IOC" },
            { company: "MGL", symbol: "MGL" }, { company: "OIL", symbol: "OIL" },
            { company: "ONGC", symbol: "ONGC" }, { company: "PETRONET", symbol: "PETRONET" },
            { company: "RELIANCE", symbol: "RELIANCE" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY O--GAS"));

        // Consumer Durables
        [
            { company: "AMBER", symbol: "AMBER" }, { company: "BLUESTARCO", symbol: "BLUESTARCO" },
            { company: "CROMPTON", symbol: "CROMPTON" }, { company: "DIXON", symbol: "DIXON" },
            { company: "HAVELLS", symbol: "HAVELLS" }, { company: "KALYANKJIL", symbol: "KALYANKJIL" },
            { company: "PGEL", symbol: "PGEL" }, { company: "TITAN", symbol: "TITAN" },
            { company: "VOLTAS", symbol: "VOLTAS" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY ConDUR"));

        // Consumption
        [
            { company: "APOLLOHOSP", symbol: "APOLLOHOSP" }, { company: "ASIANPAINT", symbol: "ASIANPAINT" },
            { company: "BAJAJ-AUTO", symbol: "BAJAJ-AUTO" }, { company: "BHARTIARTL", symbol: "BHARTIARTL" },
            { company: "BRITANNIA", symbol: "BRITANNIA" }, { company: "COLPAL", symbol: "COLPAL" },
            { company: "DABUR", symbol: "DABUR" }, { company: "DLF", symbol: "DLF" },
            { company: "DMART", symbol: "DMART" }, { company: "EICHERMOT", symbol: "EICHERMOT" },
            { company: "ETERNAL", symbol: "ETERNAL" }, { company: "GODREJCP", symbol: "GODREJCP" },
            { company: "HAVELLS", symbol: "HAVELLS" }, { company: "HEROMOTOCO", symbol: "HEROMOTOCO" },
            { company: "HINDUNILVR", symbol: "HINDUNILVR" }, { company: "INDIGO", symbol: "INDIGO" },
            { company: "INDHOTEL", symbol: "INDHOTEL" }, { company: "ITC", symbol: "ITC" },
            { company: "M&M", symbol: "M&M" }, { company: "MARICO", symbol: "MARICO" },
            { company: "MARUTI", symbol: "MARUTI" }, { company: "MAXHEALTH", symbol: "MAXHEALTH" },
            { company: "NAUKRI", symbol: "NAUKRI" }, { company: "NESTLEIND", symbol: "NESTLEIND" },
            { company: "PATANJALI", symbol: "PATANJALI" }, { company: "TATACONSUM", symbol: "TATACONSUM" },
            { company: "TATAPOWER", symbol: "TATAPOWER" }, { company: "TITAN", symbol: "TITAN" },
            { company: "TVSMOTOR", symbol: "TVSMOTOR" }, { company: "UNITDSPR", symbol: "UNITDSPR" },
            { company: "VBL", symbol: "VBL" },
            { company: "ABFRL", symbol: "ABFRL" }, // Added ABFRL
            { company: "JUBLFOOD", symbol: "JUBLFOOD" }, // Added JUBLFOOD
            { company: "NYKAA", symbol: "NYKAA" }, // Added NYKAA
            { company: "TRENT", symbol: "TRENT" } // Added TRENT
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY CONSUMP"));

        // Nifty Infra
        [
            { company: "BHARTIARTL", symbol: "BHARTIARTL" }, { company: "APOLLOHOSP", symbol: "APOLLOHOSP" },
            { company: "ULTRACEMCO", symbol: "ULTRACEMCO" }, { company: "MAXHEALTH", symbol: "MAXHEALTH" },
            { company: "DLF", symbol: "DLF" }, { company: "CUMMINSIND", symbol: "CUMMINSIND" },
            { company: "AMBUJACEM", symbol: "AMBUJACEM" }, { company: "GAIL", symbol: "GAIL" },
            { company: "SIEMENS", symbol: "SIEMENS" }, { company: "TATAPOWER", symbol: "TATAPOWER" },
            { company: "ASHOKLEY", symbol: "ASHOKLEY" }, { company: "BHARATFORG", symbol: "BHARATFORG" },
            { company: "HINDPETRO", symbol: "HINDPETRO" }, { company: "ADANIPORTS", symbol: "ADANIPORTS" },
            { company: "CGPOWER", symbol: "CGPOWER" }, { company: "IOC", symbol: "IOC" },
            { company: "ADANIGREEN", symbol: "ADANIGREEN" }, { company: "ONGC", symbol: "ONGC" },
            { company: "MOTHERSON", symbol: "MOTHERSON" }, { company: "SHREECEM", symbol: "SHREECEM" },
            { company: "INDHOTEL", symbol: "INDHOTEL" }, { company: "BPCL", symbol: "BPCL" },
            { company: "GODREJPROP", symbol: "GODREJPROP" }, { company: "INDUSTOWER", symbol: "INDUSTOWER" },
            { company: "GRASIM", symbol: "GRASIM" }, { company: "INDIGO", symbol: "INDIGO" },
            { company: "NTPC", symbol: "NTPC" }, { company: "LT", symbol: "LT" },
            { company: "RELIANCE", symbol: "RELIANCE" }, { company: "POWERGRID", symbol: "POWERGRID" },
            { company: "BDL", symbol: "BDL" }, // Added BDL
            { company: "IRB", symbol: "IRB" }, // Added IRB
            { company: "MAZDOCK", symbol: "MAZDOCK" }, // Added MAZDOCK
            { company: "NBCC", symbol: "NBCC" }, // Added NBCC
            { company: "NCC", symbol: "NCC" }, // Added NCC
            { company: "RVNL", symbol: "RVNL" }, // Added RVNL
            { company: "TITAGARH", symbol: "TITAGARH" } // Added TITAGARH
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY INFRA"));

        // Nifty Midcap 50 (Combined from part1 and part2)
        // Ensuring all 50 stocks are explicitly listed and added
        [
            { company: "PHOENIXLTD", symbol: "PHOENIXLTD" }, { company: "COFORGE", symbol: "COFORGE" },
            { company: "SUPREMEIND", symbol: "SUPREMEIND" }, { company: "LUPIN", symbol: "LUPIN" },
            { company: "AUROPHARMA", symbol: "AUROPHARMA" }, { company: "PERSISTENT", symbol: "PERSISTENT" },
            { company: "MAXHEALTH", symbol: "MAXHEALTH" }, { company: "MUTHOOTFIN", symbol: "MUTHOOTFIN" },
            { company: "ALKEM", symbol: "ALKEM" }, { company: "SBICARD", symbol: "SBICARD" },
            { company: "DIXON", symbol: "DIXON" }, { company: "CUMMINSIND", symbol: "CUMMINSIND" },
            { company: "MPHASIS", symbol: "MPHASIS" }, { company: "CONCOR", symbol: "CONCOR" },
            { company: "MRF", symbol: "MRF" }, { company: "ASTRAL", symbol: "ASTRAL" },
            { company: "HDFCAMC", symbol: "HDFCAMC" }, { company: "PIIND", symbol: "PIIND" },
            { company: "IDEA", symbol: "IDEA" }, { company: "NMDC", symbol: "NMDC" },
            { company: "NHPC", symbol: "NHPC" }, { company: "PETRONET", symbol: "PETRONET" },
            { company: "TIINDIA", symbol: "TIINDIA" }, { company: "VOLTAS", symbol: "VOLTAS" },
            { company: "COLPAL", symbol: "COLPAL" }, { company: "DELHIVERY", symbol: "DELHIVERY" }, // Added DELHIVERY
            { company: "IRCTC", symbol: "IRCTC" },
            { company: "OFSS", symbol: "OFSS" }, { company: "OIL", symbol: "OIL" },
            { company: "POLYCAB", symbol: "POLYCAB" }, { company: "OBEROIRLTY", symbol: "OBEROIRLTY" },
            { company: "PAGEIND", symbol: "PAGEIND" }, { company: "TORNTPOWER", symbol: "TORNTPOWER" },
            { company: "MARICO", symbol: "MARICO" }, { company: "PRESTIGE", symbol: "PRESTIGE" },
            { company: "GMRAIRPORT", symbol: "GMRAIRPORT" }, { company: "ASHOKLEY", symbol: "ASHOKLEY" },
            { company: "POLICYBZR", symbol: "POLICYBZR" }, { company: "YESBANK", symbol: "YESBANK" },
            { company: "AUBANK", symbol: "AUBANK" }, { company: "BHARATFORG", symbol: "BHARATFORG" },
            { company: "SAIL", symbol: "SAIL" }, { company: "HINDPETRO", symbol: "HINDPETRO" },
            { company: "FEDERALBNK", symbol: "FEDERALBNK" }, { company: "INDUSTOWER", symbol: "INDUSTOWER" },
            { company: "PAYTM", symbol: "PAYTM" }, { company: "GODREJPROP", symbol: "GODREJPROP" },
            { company: "SRF", symbol: "SRF" }, { company: "BHEL", symbol: "BHEL" },
            { company: "IDFCFIRSTB", symbol: "IDFCFIRSTB" }, { company: "BSE", symbol: "BSE" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY MIDCAP 50"));

        // Nifty Media
        [
            { company: "HATHWAY", symbol: "HATHWAY" }, { company: "DISHTV", symbol: "DISHTV" },
            { company: "DBCORP", symbol: "DBCORP" }, { company: "NAZARA", symbol: "NAZARA" },
            { company: "TIPSMUSIC", symbol: "TIPSMUSIC" }, { company: "SAREGAMA", symbol: "SAREGAMA" },
            { company: "SUNTV", symbol: "SUNTV" }, { company: "PVRINOX", symbol: "PVRINOX" },
            { company: "NETWORK18", symbol: "NETWORK18" }, { company: "ZEEL", symbol: "ZEEL" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY MEDIA"));

        // Nifty Next 50 (Combined from part1 and part2)
        [
            { company: "TORNTPHARM", symbol: "TORNTPHARM" }, { company: "ZYDUSLIFE", symbol: "ZYDUSLIFE" },
            { company: "ICICIGI", symbol: "ICICIGI" }, { company: "DIVISLAB", symbol: "DIVISLAB" },
            { company: "PIDILITIND", symbol: "PIDILITIND" }, { company: "HYUNDAI", symbol: "HYUNDAI" },
            { company: "DLF", symbol: "DLF" }, { company: "VBL", symbol: "VBL" },
            { company: "BOSCHLTD", symbol: "BOSCHLTD" }, { company: "DABUR", symbol: "DABUR" },
            { company: "ABB", symbol: "ABB" }, { company: "GODREJCP", symbol: "GODREJCP" },
            { company: "JINDALSTEL", symbol: "JINDALSTEL" }, { company: "AMBUJACEM", symbol: "AMBUJACEM" },
            { company: "BAJAJHFL", symbol: "BAJAJHFL" }, { company: "SIEMENS", symbol: "SIEMENS" },
            { company: "TATAPOWER", symbol: "TATAPOWER" }, { company: "IRFC", symbol: "IRFC" },
            { company: "SWIGGY", symbol: "SWIGGY" }, { company: "GAIL", symbol: "GAIL" },
            { company: "BANKBARODA", symbol: "BANKBARODA" }, { company: "UNITDSPR", symbol: "UNITDSPR" },
            { company: "LICI", symbol: "LICI" }, { company: "JSWENERGY", symbol: "JSWENERGY" },
            { company: "LTIM", symbol: "LTIM" }, { company: "BRITANNIA", symbol: "BRITANNIA" },
            { company: "LODHA", symbol: "LODHA" }, { company: "ADANIPOWER", symbol: "ADANIPOWER" }, // Added ADANIPOWER
            { company: "REC", symbol: "REC" }, { company: "PNB", symbol: "PNB" },
            { company: "ADANINEOSL", symbol: "ADANINEOSL" }, // Added ADANINEOSL
            { company: "MOTHERSON", symbol: "MOTHERSON" }, { company: "DMART", symbol: "DMART" },
            { company: "IOC", symbol: "IOC" },
            { company: "CGPOWER", symbol: "CGPOWER" }, { company: "NAUKRI", symbol: "NAUKRI" },
            { company: "BPCL", symbol: "BPCL" }, { company: "VEDL", symbol: "VEDL" },
            { company: "INDHOTEL", symbol: "INDHOTEL" }, { company: "PFC", symbol: "PFC" },
            { company: "SHREECEM", symbol: "SHREECEM" }, { company: "CHOLAFIN", symbol: "CHOLAFIN" },
            { company: "ICICIPRULI", symbol: "ICICIPRULI" }, { company: "TVSMOTOR", symbol: "TVSMOTOR" },
            { company: "INDIGO", symbol: "INDIGO" }, { company: "BAJAJHLDNG", symbol: "BAJAJHLDNG" }, // Added BAJAJHLDNG
            { company: "HAL", symbol: "HAL" }, // Added HAL
            { company: "HAVELLS", symbol: "HAVELLS" },
            { company: "CANBK", symbol: "CANBK" }, { company: "ADANIGREEN", symbol: "ADANIGREEN" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY NEXT 50"));

        // Nifty Smallcap 50 (Combined from part1 and part2)
        [
            { company: "IEX", symbol: "IEX" }, { company: "KAYNES", symbol: "KAYNES" },
            { company: "CYIENT", symbol: "CYIENT" }, { company: "BSOFT", symbol: "BSOFT" },
            { company: "BRIGADE", symbol: "BRIGADE" }, { company: "CESC", symbol: "CESC" },
            { company: "PPLPHARMA", symbol: "PPLPHARMA" }, { company: "LALPATHLAB", symbol: "LALPATHLAB" },
            { company: "NEULANDLAB", symbol: "NEULANDLAB" }, { company: "NAVINFLUOR", symbol: "NAVINFLUOR" },
            { company: "AARTIIND", symbol: "AARTIIND" }, { company: "TEJASNET", symbol: "TEJASNET" },
            { company: "AEGISLOG", symbol: "AEGISLOG" }, { company: "RKFORGE", symbol: "RKFORGE" },
            { company: "HFCL", symbol: "HFCL" }, { company: "FSL", symbol: "FSL" },
            { company: "ARE&M", symbol: "ARE&M" }, { company: "KEC", symbol: "KEC" },
            { company: "POLYCAB", symbol: "POLYCAB" }, { company: "JSL", symbol: "JSL" },
            { company: "NHPC", symbol: "NHPC" }, { company: "SJVN", symbol: "SJVN" },
            { company: "IRFC", symbol: "IRFC" }, { company: "HUDCO", symbol: "HUDCO" },
            { company: "RBLBANK", symbol: "RBLBANK" }, { company: "OIL", symbol: "OIL" },
            { company: "PFC", symbol: "PFC" }, { company: "REC", symbol: "REC" },
            { company: "PNB", symbol: "PNB" }, { company: "BANKINDIA", symbol: "BANKINDIA" },
            { company: "UNIONBANK", symbol: "UNIONBANK" }, { company: "IDFCFIRSTB", symbol: "IDFCFIRSTB" },
            { company: "BANDHANBNK", symbol: "BANDHANBNK" }, { company: "AUROPHARMA", symbol: "AUROPHARMA" },
            { company: "BIOCON", symbol: "BIOCON" }, { company: "GLENMARK", symbol: "GLENMARK" },
            { company: "GRANULES", symbol: "GRANULES" }, { company: "LAURUSLABS", symbol: "LAURUSLABS" },
            { company: "MANKIND", symbol: "MANKIND" }, { company: "SYNGENE", symbol: "SYNGENE" },
            { company: "HINDCOPPER", symbol: "HINDCOPPER" }, { company: "HINDZINC", symbol: "HINDZINC" },
            { company: "NATIONALUM", symbol: "NATIONALUM" }, { company: "NMDC", symbol: "NMDC" },
            { company: "GODREJCP", symbol: "GODREJCP" }, { company: "VBL", symbol: "VBL" },
            { company: "EXIDEIND", symbol: "EXIDEIND" }, { company: "MOTHERSON", symbol: "MOTHERSON" },
            { company: "UNOMINDA", symbol: "UNOMINDA" }, { company: "BALKRISIND", symbol: "BALKRISIND" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY SMALLCAP 50"));

        // Nifty Private Bank
        [
            { company: "AXISBANK", symbol: "AXISBANK" }, { company: "HDFCBANK", symbol: "HDFCBANK" },
            { company: "ICICIBANK", symbol: "ICICIBANK" }, { company: "INDUSINDBK", symbol: "INDUSINDBK" },
            { company: "KOTAKBANK", symbol: "KOTAKBANK" }, { company: "YESBANK", symbol: "YESBANK" },
            { company: "BANDHANBNK", symbol: "BANDHANBNK" }, { company: "IDFCFIRSTB", symbol: "IDFCFIRSTB" },
            { company: "AUBANK", symbol: "AUBANK" }, { company: "RBLBANK", symbol: "RBLBANK" }
        ].forEach(s => addStock(s.company, s.symbol, "NIFTY PBANK"));

        return Array.from(hawkViewStocksMap.values()).sort((a, b) => a.symbol.localeCompare(b.symbol));
    })();


    const STRATEGIES = [
        "Breakout Trading", "Scalping", "Momentum Trading", "Swing Trading",
        "Positional Trading", "Arbitrage", "Value Investing", "Option Selling",
        "Option Buying (Directional)", "Intraday Trading", "F&O Hedging"
    ];

    // Emotion data with associated emojis
    const EMOTIONS = [
        { name: "Confident", emoji: "😎" },
        { name: "Anxious", emoji: "😟" },
        { name: "Greedy", emoji: "🤑" },
        { name: "Fearful", emoji: "😨" },
        { name: "Disciplined", emoji: "🤖" },
        { name: "Impatient", emoji: "😤" },
        { name: "Patient", emoji: "😌" },
        { name: "Frustrated", emoji: "😡" },
        { name: "Excited", emoji: "🤩" },
        { name: "Calm", emoji: "🧘" },
        { name: "Overconfident", emoji: "😬" }
    ];

    const instrumentTypes = [
        "Cash", "Futures", "Options-CE", "Options-PE"
    ];

    const tradeResults = [
        "Win", "Loss", "Breakeven"
    ];

    let allTrades = []; // Cache all trades globally
    let allReflections = []; // Cache all reflections globally

    // Track current month and year for calendar
    let currentCalendarDate = new Date();

    // === SCAN MODE CORE LOGIC ===
    let scanModeActive = false; // Controls if popup mode is active
    let scanModePopup = null; // Hover popup window reference
    let newTabModeActive = false; // Controls if new tab mode is active
    let scanModeNewTabWindow = null; // Reusable window for new tab mode

    // Function to update the text content of the scan mode toggle button
    function updateScanModeButtonText() {
        const scanModeToggle = document.getElementById('scanModeToggle');
        if (scanModeToggle) {
            const scanModeTextSpan = scanModeToggle.querySelector('span:not(.scan-icon)');
            if (scanModeTextSpan) {
                if (newTabModeActive) {
                    scanModeTextSpan.textContent = 'Scan Mode - On Newtab';
                } else if (scanModeActive) {
                    scanModeTextSpan.textContent = 'Scan Mode - On Popup';
                } else {
                    scanModeTextSpan.textContent = 'Scan Mode - Off';
                }
            }
        }
    }

    // Function to update styling of symbol cells based on scan mode
    function updateSymbolCellStyling() {
        const symbolCells = document.querySelectorAll('.symbol-cell');
        symbolCells.forEach(cell => {
            if (scanModeActive || newTabModeActive) {
                cell.classList.add('scan-mode-active-symbol');
            } else {
                cell.classList.remove('scan-mode-active-symbol');
            }
        });
    }

    // Toggle Scan Mode (CMD/CTRL + SHIFT + S)
    function toggleScanMode() {
        scanModeActive = !scanModeActive;
        // If scan mode (popup) is activated, ensure new tab mode is off
        if (scanModeActive) {
            newTabModeActive = false;
        }

        const scanModeToggle = document.getElementById('scanModeToggle');
        if (scanModeToggle) {
            scanModeToggle.classList.toggle('active', scanModeActive || newTabModeActive); // Active if either is on
        }
        localStorage.setItem('scanModeActive', scanModeActive);
        localStorage.setItem('newTabModeActive', newTabModeActive); // Save new tab mode state too

        // Close any open windows if modes are deactivated
        if (!scanModeActive) {
            if (scanModePopup && !scanModePopup.closed) {
                scanModePopup.close();
                scanModePopup = null;
            }
        }
        // Always close new tab window if newTabModeActive is false
        if (!newTabModeActive) {
            if (scanModeNewTabWindow && !scanModeNewTabWindow.closed) {
                scanModeNewTabWindow.close();
                scanModeNewTabWindow = null;
            }
        }
        updateSymbolCellStyling(); // Update styling of symbol cells
        updateScanModeButtonText(); // Update button text
    }

    // Toggle New Tab Mode (CMD/CTRL + SHIFT + K)
    function toggleNewTabMode() {
        newTabModeActive = !newTabModeActive;
        // If new tab mode is activated, ensure scan mode (popup) is off
        if (newTabModeActive) {
            scanModeActive = false;
        }

        const scanModeToggle = document.getElementById('scanModeToggle');
        if (scanModeToggle) {
            scanModeToggle.classList.toggle('active', scanModeActive || newTabModeActive); // Active if either is on
        }
        localStorage.setItem('newTabModeActive', newTabModeActive);
        localStorage.setItem('scanModeActive', scanModeActive); // Save scan mode state too

        // Close any open windows if modes are deactivated
        if (!newTabModeActive) {
            if (scanModeNewTabWindow && !scanModeNewTabWindow.closed) {
                scanModeNewTabWindow.close();
                scanModeNewTabWindow = null;
            }
        }
        // Always close popup window if scanModeActive is false
        if (!scanModeActive) {
            if (scanModePopup && !scanModePopup.closed) {
                scanModePopup.close();
                scanModePopup = null;
            }
        }
        updateSymbolCellStyling(); // Update styling of symbol cells
        updateScanModeButtonText(); // Update button text
    }

    // Open TradingView window function
    function openTradingViewWindow(ticker) {
        if (!ticker) return;
        const url = `https://www.tradingview.com/chart/?symbol=NSE:${ticker}`;

        if (newTabModeActive) {
            // NEW TAB MODE: Open/reuse in a new tab
            if (scanModeNewTabWindow && !scanModeNewTabWindow.closed) {
                scanModeNewTabWindow.location.href = url;
                scanModeNewTabWindow.focus();
            } else {
                // Open a new tab and store its reference for reuse
                scanModeNewTabWindow = window.open(url, "NerdyTradesChartTab");
            }
        } else if (scanModeActive) {
            // SCAN MODE (default): Open/reuse in a popup window
            if (scanModePopup && !scanModePopup.closed) {
                scanModePopup.location.href = url;
                scanModePopup.focus();
            } else {
                // Open a new popup window and store its reference for reuse
                scanModePopup = window.open(
                    url,
                    "NerdyTradesChartPopup", // A unique name for the popup window
                    "width=1000,height=600,left=100,top=100,resizable=yes,scrollbars=yes"
                );
            }
        }
    }
    // === END SCAN MODE CORE LOGIC ===


    // --- Utility Functions ---

    /**
     * Displays a custom modal message.
     * @param {string} title - The title of the message.
     * @param {string} message - The content of the message.
     * @returns {Promise<void>} A promise that resolves when the user clicks OK.
     */
    function showMessage(title, message) {
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('message-title');
        const modalText = document.getElementById('message-text');
        const closeButton = document.getElementById('message-close-button');
        const okButton = document.getElementById('message-ok-button');

        modalTitle.textContent = title;
        modalText.textContent = message;
        modal.style.display = 'flex'; // Show the modal

        return new Promise((resolve) => {
            const closeHandler = () => {
                modal.style.display = 'none';
                closeButton.removeEventListener('click', closeHandler);
                okButton.removeEventListener('click', closeHandler);
                resolve();
            };
            closeButton.addEventListener('click', closeHandler);
            okButton.addEventListener('click', closeHandler);
        });
    }

    /**
     * Formats a number to Indian Rupee currency.
     * @param {number} amount - The amount to format.
     * @returns {string} The formatted currency string.
     */
    function formatRupee(amount) {
        if (typeof amount !== 'number' && typeof amount !== 'string') return '';
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Number(amount));
    }

    /**
     * Calculates the percentage change.
     * @param {number} startValue - The initial value.
     * @param {number} endValue - The final value.
     * @returns {string} The percentage change formatted.
     */
    function calculatePercentageChange(startValue, endValue) {
        if (startValue === 0) return 'N/A';
        const change = ((endValue - startValue) / startValue) * 100;
        return `${change.toFixed(2)}%`;
    }

    /**
     * Destroys all Chart.js instances.
     * Prevents issues when re-rendering charts.
     */
    function destroyAllCharts() {
        Chart.helpers.each(Chart.instances, function(instance) {
            instance.destroy();
        });
    }

    /**
     * Calculates brokerage and taxes for a given trade based on new rates.
     * @param {string} tradeType - 'equity_delivery', 'equity_intraday', 'futures', 'options'.
     * @param {number} buyPrice - Buy price per unit.
     * @param {number} sellPrice - Sell price per unit.
     * @param {number} lotsTaken - Number of lots.
     * @param {number} lotSize - Lot size for F&O.
     * @returns {object} Object containing calculated charges.
     */
    function calculateBrokerageAndTaxes(tradeType, buyPrice, sellPrice, lotsTaken, lotSize) {
        let brokerage = 0;
        let stt = 0; // Securities Transaction Tax / Commodities Transaction Tax
        let transactionCharges = 0; // Exchange Transaction Charges
        let stampDuty = 0; // Stamp Charges
        let sebiCharges = 0; // SEBI Turnover Fees
        let gst = 0; // Goods and Services Tax

        const buyValue = buyPrice * lotsTaken * lotSize;
        const sellValue = sellPrice * lotsTaken * lotSize;
        const turnover = buyValue + sellValue;

        // Common SEBI Charges: ₹10 / crore = 0.000001% of turnover
        sebiCharges = (turnover / 10000000) * 10; 

        switch (tradeType) {
            case 'equity_delivery':
                brokerage = 0; // Zero brokerage
                stt = sellValue * 0.001; // 0.1% on sell side
                transactionCharges = turnover * 0.0000297; // 0.00297%
                stampDuty = buyValue * 0.00015; // 0.015% or ₹1500 / crore on buy side
                break;
            case 'equity_intraday':
                const intradayBrokerageBuy = Math.min(buyValue * 0.0003, 20); // 0.03% or ₹20 per order
                const intradayBrokerageSell = Math.min(sellValue * 0.0003, 20);
                brokerage = intradayBrokerageBuy + intradayBrokerageSell;
                stt = sellValue * 0.000025; // 0.025% on sell side
                transactionCharges = turnover * 0.0000297; // 0.00297%
                stampDuty = buyValue * 0.00003; // 0.003% or ₹300 / crore on buy side
                break;
            case 'futures':
                const futuresBrokerageBuy = Math.min(buyValue * 0.00002, 20); // 0.03% or ₹20 per order
                const futuresBrokerageSell = Math.min(sellValue * 0.00002, 20);
                brokerage = futuresBrokerageBuy + futuresBrokerageSell;
                stt = sellValue * 0.00001; // 0.01% on sell side
                transactionCharges = turnover * 0.0000173; // 0.00173%
                stampDuty = buyValue * 0.000002; // 0.002% or ₹200 / crore on buy side
                break;
            case 'options':
                brokerage = 20 * 2; // Flat ₹20 per executed order (buy and sell)
                stt = sellValue * 0.001; // 0.1% on sell side (on premium value)
                transactionCharges = turnover * 0.0003503; // 0.03503% (on premium)
                stampDuty = buyValue * 0.000003; // 0.003% or ₹300 / crore on buy side
                break;
        }

        // GST is 18% on (brokerage + SEBI + transaction charges) for all types
        gst = 0.18 * (brokerage + sebiCharges + transactionCharges);

        const totalCharges = brokerage + stt + transactionCharges + stampDuty + sebiCharges + gst;

        return {
            brokerage: brokerage,
            stt: stt,
            transactionCharges: transactionCharges,
            stampDuty: stampDuty,
            sebiCharges: sebiCharges,
            gst: gst,
            totalCharges: totalCharges
        };
    }


    // --- IndexedDB Functions ---

    /**
     * Initializes the IndexedDB database.
     * Creates the 'trades' and 'reflections' object stores if they don't exist.
     * @returns {Promise<IDBDatabase>} A promise that resolves with the database instance.
     */
    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_TRADES)) {
                    const tradeStore = db.createObjectStore(STORE_TRADES, { keyPath: 'id', autoIncrement: true });
                    tradeStore.createIndex('date', 'entryDate', { unique: false });
                    tradeStore.createIndex('instrument', 'instrument', { unique: false });
                    tradeStore.createIndex('strategy', 'strategyUsed', { unique: false });
                    tradeStore.createIndex('result', 'result', { unique: false });
                    tradeStore.createIndex('entryExitDate', ['entryDate', 'exitDate'], { unique: false });
                }
                if (!db.objectStoreNames.contains(STORE_REFLECTIONS)) {
                    const reflectionStore = db.createObjectStore(STORE_REFLECTIONS, { keyPath: 'id', autoIncrement: true });
                    reflectionStore.createIndex('date', 'date', { unique: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };

            request.onerror = (event) => {
                console.error("IndexedDB error:", event.target.errorCode);
                showMessage("Error", "Failed to open database. Please try again.");
                reject(event.target.error);
            };
        });
    }

    /**
     * Adds a new entry to a specified IndexedDB store.
     * @param {string} storeName - The name of the object store (e.g., STORE_TRADES, STORE_REFLECTIONS).
     * @param {Object} data - The object to add.
     * @returns {Promise<void>} A promise that resolves when the data is added.
     */
    function addEntry(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const objectStore = transaction.objectStore(storeName);
            const request = objectStore.add(data);

            request.onsuccess = () => {
                resolve();
            };

            request.onerror = (event) => {
                console.error(`Error adding entry to ${storeName}:`, event.target.error);
                reject(event.target.error);
            };
        });
    }

    /**
     * Updates an existing entry in a specified IndexedDB store.
     * @param {string} storeName - The name of the object store.
     * @param {Object} data - The object to update (must contain keyPath).
     * @returns {Promise<void>} A promise that resolves when the data is updated.
     */
    function updateEntry(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const objectStore = transaction.objectStore(storeName);
            const request = objectStore.put(data); // `put` updates if exists, adds if not

            request.onsuccess = () => {
                resolve();
            };

            request.onerror = (event) => {
                console.error(`Error updating entry in ${storeName}:`, event.target.error);
                reject(event.target.error);
            };
        });
    }


    /**
     * Retrieves all entries from a specified IndexedDB store.
     * @param {string} storeName - The name of the object store.
     * @returns {Promise<Array<Object>>} A promise that resolves with an array of objects.
     */
    async function getEntries(storeName) {
        return new Promise((resolve, reject) => {
            if (!db) {
                console.error("Database not open.");
                return reject(new Error("Database not open."));
            }
            const transaction = db.transaction([storeName], 'readonly');
            const objectStore = transaction.objectStore(storeName);
            const request = objectStore.getAll();

            request.onsuccess = (event) => {
                resolve(event.target.result);
            };

            request.onerror = (event) => {
                console.error(`Error getting entries from ${storeName}:`, event.target.error);
                reject(event.target.error);
            };
        });
    }

    /**
     * Deletes an entry from a specified IndexedDB store by ID.
     * @param {string} storeName - The name of the object store.
     * @param {number} id - The ID of the entry to delete.
     * @returns {Promise<void>} A promise that resolves when the entry is deleted.
     */
    function deleteEntry(storeName, id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const objectStore = transaction.objectStore(storeName);
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                resolve();
            };

            request.onerror = (event) => {
                console.error(`Error deleting entry from ${storeName}:`, event.target.error);
                reject(event.target.error);
            };
        });
    }

    /**
     * Clears all data from a specified IndexedDB store.
     * @param {string} storeName - The name of the object store.
     * @returns {Promise<void>} A promise that resolves when the store is cleared.
     */
    function clearStore(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const objectStore = transaction.objectStore(storeName);
            const request = objectStore.clear();

            request.onsuccess = () => {
                resolve();
            };

            request.onerror = (event) => {
                console.error(`Error clearing store ${storeName}:`, event.target.error);
                reject(event.target.error);
            };
        });
    }


    // --- UI Rendering Functions ---

    /**
     * Renders the Add Trade form with improved UI.
     * @param {Object} [tradeToEdit=null] - Optional trade object to pre-fill the form for editing.
     */
    function renderAddTradeForm(tradeToEdit = null) {
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl border border-zinc-700">
                <h2 class="text-2xl font-bold mb-5 text-indigo-400">${tradeToEdit ? 'Edit Trade Entry' : 'Add New Trade Entry'}</h2>
                <form id="trade-entry-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${tradeToEdit ? `<input type="hidden" id="trade-id" name="id" value="${tradeToEdit.id}">` : ''}

                    <div class="form-section col-span-full">
                        <h3 class="form-section-title flex items-center"><i data-lucide="info" class="mr-2"></i> Trade Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-full input-group relative">
                                <i data-lucide="building-2" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="text" id="instrument" name="instrument" placeholder="Instrument (e.g., Nifty Bank, Reliance)" required>
                                <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
                            </div>
                            <div class="input-group">
                                 <i data-lucide="clipboard-type" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <select id="type" name="type" required></select>
                            </div>
                            <div class="input-group">
                                <i data-lucide="flag" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <select id="strategy" name="strategy" required></select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section col-span-full">
                        <h3 class="form-section-title flex items-center"><i data-lucide="clock" class="mr-2"></i> Entry & Exit Timings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group">
                                <i data-lucide="calendar" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="date" id="entry-date" name="entryDate" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="clock" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="time" id="entry-time" name="entryTime" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="calendar" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="date" id="exit-date" name="exitDate" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="clock" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="time" id="exit-time" name="exitTime" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section col-span-full">
                        <h3 class="form-section-title flex items-center"><i data-lucide="trending-up" class="mr-2"></i> Price & Quantity</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group">
                                <i data-lucide="indian-rupee" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="number" id="entry-price" name="entryPrice" step="0.01" placeholder="Entry Price" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="indian-rupee" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="number" id="exit-price" name="exitPrice" step="0.01" placeholder="Exit Price" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="hash" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="number" id="quantity" name="quantity" placeholder="Quantity / Lots" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="check-circle-2" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <select id="result" name="result" required></select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section col-span-full">
                        <h3 class="form-section-title flex items-center"><i data-lucide="smile" class="mr-2"></i> Emotional State</h3>
                        <label class="block text-zinc-300 text-sm font-bold mb-2">Select Emotions:</label>
                        <div id="emotion-emoji-grid" class="emotion-emoji-grid"></div>
                    </div>

                    <div class="form-section col-span-full">
                        <h3 class="form-section-title flex items-center"><i data-lucide="file-text" class="mr-2"></i> Notes & Media</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="input-group items-start">
                                <i data-lucide="pencil" class="text-zinc-400 mr-3 mt-2 flex-shrink-0"></i>
                                <textarea id="notes" name="notes" rows="3" placeholder="Notes & Learnings"></textarea>
                            </div>
                            <div class="input-group">
                                <i data-lucide="folder-output" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="text" id="drive-link" name="driveLink" placeholder="Google Drive Folder Link (Required)" required>
                            </div>
                            <div class="input-group">
                                <i data-lucide="tags" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                                <input type="text" id="tags" name="tags" placeholder="Tags (e.g., momentum, scalp, breakout)">
                            </div>
                        </div>
                    </div>

                    <div class="col-span-full flex justify-end mt-4">
                        <button type="submit" class="btn-primary">${tradeToEdit ? 'Update Trade' : 'Save Trade'}</button>
                    </div>
                </form>
            </div>
        `;
        populateFormSelects(); // Populates dropdowns and emoji grid
        const form = document.getElementById('trade-entry-form');
        form.addEventListener('submit', handleTradeFormSubmit);

        // Add event listeners for instrument selection and type change for lot size auto-fill
        const instrumentInput = document.getElementById('instrument');
        const typeSelect = document.getElementById('type');
        const quantityInput = document.getElementById('quantity');

        // Function to update quantity based on instrument and type
        const updateQuantityBasedOnLotSize = () => {
            const selectedInstrumentSymbol = instrumentInput.value.toUpperCase();
            const selectedType = typeSelect.value;
            const instrumentData = INSTRUMENTS_AND_LOT_SIZES.find(item => item.symbol === selectedInstrumentSymbol);

            if (instrumentData && (selectedType === 'Futures' || selectedType.startsWith('Options-'))) {
                quantityInput.value = instrumentData.lotSize;
                quantityInput.readOnly = true; // Make quantity read-only for F&O
            } else {
                quantityInput.value = ''; // Clear for cash or if no instrument data
                quantityInput.readOnly = false; // Make quantity editable
            }
        };

        // Listen for changes on both instrument input (after autocomplete selection) and type select
        instrumentInput.addEventListener('change', updateQuantityBasedOnLotSize);
        typeSelect.addEventListener('change', updateQuantityBasedOnLotSize);


        if (tradeToEdit) {
            // Pre-fill form for editing
            document.getElementById('instrument').value = tradeToEdit.instrument || '';
            document.getElementById('type').value = tradeToEdit.type || '';
            document.getElementById('entry-date').value = tradeToEdit.entryDate || '';
            document.getElementById('entry-time').value = tradeToEdit.entryTime || '';
            document.getElementById('exit-date').value = tradeToEdit.exitDate || '';
            document.getElementById('exit-time').value = tradeToEdit.exitTime || '';
            document.getElementById('entry-price').value = tradeToEdit.entryPrice || '';
            document.getElementById('exit-price').value = tradeToEdit.exitPrice || '';
            document.getElementById('quantity').value = tradeToEdit.quantity || '';
            document.getElementById('strategy').value = tradeToEdit.strategyUsed || '';
            document.getElementById('result').value = tradeToEdit.result || '';
            document.getElementById('notes').value = tradeToEdit.notes || '';
            document.getElementById('drive-link').value = tradeToEdit.driveLink || '';
            document.getElementById('tags').value = (tradeToEdit.tags || []).join(', ');

            // Select emotions
            if (tradeToEdit.emotions) {
                tradeToEdit.emotions.forEach(emotionName => {
                    const emojiItem = document.querySelector(`#emotion-emoji-grid [data-emotion="${emotionName}"]`);
                    if (emojiItem) {
                        emojiItem.classList.add('selected');
                    }
                });
            }
            // Also apply lot size logic when editing
            updateQuantityBasedOnLotSize();
        } else {
            // Set default date/time to now for new entries
            const now = new Date();
            document.getElementById('entry-date').value = now.toISOString().split('T')[0];
            document.getElementById('entry-time').value = now.toTimeString().substring(0, 5);
            document.getElementById('exit-date').value = now.toISOString().split('T')[0];
            document.getElementById('exit-time').value = now.toTimeString().substring(0, 5);
        }
        lucide.createIcons(); // Ensure icons are rendered

        // Add autocomplete logic after the input is in the DOM
        setupAutocomplete();
    }

    /**
     * Sets up autocomplete for the instrument input field.
     */
    function setupAutocomplete() {
        const instrumentInput = document.getElementById('instrument');
        const autocompleteSuggestions = document.getElementById('autocomplete-suggestions');
        let activeSuggestionIndex = -1;
        let filteredSymbols = [];

        instrumentInput.addEventListener('input', () => {
            const query = instrumentInput.value.toUpperCase();
            autocompleteSuggestions.innerHTML = '';
            autocompleteSuggestions.style.display = 'none';
            activeSuggestionIndex = -1;

            if (query.length < 2) return;

            filteredSymbols = INSTRUMENTS_AND_LOT_SIZES.filter(item =>
                item.symbol.includes(query) || item.company.toUpperCase().includes(query)
            ).slice(0, 10); // Limit to 10 suggestions

            if (filteredSymbols.length > 0) {
                filteredSymbols.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-suggestion-item';
                    div.textContent = `${item.symbol} (${item.company})`;
                    div.addEventListener('click', () => {
                        instrumentInput.value = item.symbol;
                        autocompleteSuggestions.innerHTML = '';
                        autocompleteSuggestions.style.display = 'none';
                        // Trigger lot size update immediately after selection
                        document.getElementById('type').dispatchEvent(new Event('change'));
                    });
                    autocompleteSuggestions.appendChild(div);
                });
                autocompleteSuggestions.style.display = 'block';
            }
        });

        instrumentInput.addEventListener('keydown', (e) => {
            const items = autocompleteSuggestions.querySelectorAll('.autocomplete-suggestion-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeSuggestionIndex = (activeSuggestionIndex + 1) % items.length;
                highlightSuggestion(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeSuggestionIndex = (activeSuggestionIndex - 1 + items.length) % items.length;
                highlightSuggestion(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeSuggestionIndex > -1) {
                    items[activeSuggestionIndex].click();
                }
            } else if (e.key === 'Escape') {
                autocompleteSuggestions.innerHTML = '';
                autocompleteSuggestions.style.display = 'none';
            }
        });

        function highlightSuggestion(items) {
            items.forEach((item, index) => {
                if (index === activeSuggestionIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        document.addEventListener('click', (e) => {
            if (!instrumentInput.contains(e.target) && !autocompleteSuggestions.contains(e.target)) {
                autocompleteSuggestions.innerHTML = '';
                autocompleteSuggestions.style.display = 'none';
            }
        });
    }


    /**
     * Populates select dropdowns and emoji grid for the trade entry form.
     */
    function populateFormSelects() {
        const typeSelect = document.getElementById('type');
        typeSelect.innerHTML = '<option value="">Select Type</option>'; // Add a default placeholder
        instrumentTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        const strategySelect = document.getElementById('strategy');
        strategySelect.innerHTML = '<option value="">Select Strategy</option>';
        STRATEGIES.forEach(strategy => {
            const option = document.createElement('option');
            option.value = strategy;
            option.textContent = strategy;
            strategySelect.appendChild(option);
        });

        const resultSelect = document.getElementById('result');
        resultSelect.innerHTML = '<option value="">Select Result</option>';
        tradeResults.forEach(result => {
            const option = document.createElement('option');
            option.value = result;
            option.textContent = result;
            resultSelect.appendChild(option);
        });

        const emotionEmojiGrid = document.getElementById('emotion-emoji-grid');
        emotionEmojiGrid.innerHTML = ''; // Clear existing
        EMOTIONS.forEach(emotion => {
            const div = document.createElement('div');
            div.className = "emotion-emoji-item";
            div.setAttribute('data-emotion', emotion.name);
            div.innerHTML = `
                <span class="emoji">${emotion.emoji}</span>
                <span>${emotion.name}</span>
            `;
            div.addEventListener('click', () => {
                div.classList.toggle('selected');
            });
            emotionEmojiGrid.appendChild(div);
        });
    }

    /**
     * Handles the submission of the trade entry form.
     * @param {Event} event - The form submission event.
     */
    async function handleTradeFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const tradeData = {};

        for (const [key, value] of formData.entries()) {
            if (key === 'tags') {
                tradeData[key] = value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            } else if (['entryPrice', 'exitPrice', 'quantity'].includes(key)) {
                tradeData[key] = parseFloat(value);
            } else {
                tradeData[key] = value;
            }
        }

        // Get selected emotions from the emoji grid
        tradeData.emotions = Array.from(document.querySelectorAll('#emotion-emoji-grid .emotion-emoji-item.selected'))
                                .map(el => el.getAttribute('data-emotion'));

        // Calculate P&L
        const pnl = (tradeData.exitPrice - tradeData.entryPrice) * tradeData.quantity; // Corrected PnL calculation
        tradeData.pnl = pnl;

        // Validate Google Drive Link format
        const googleDriveLinkRegex = /^https:\/\/drive\.google\.com\/(drive\/folders\/|file\/d\/)[a-zA-Z0-9_-]+/;
        if (!googleDriveLinkRegex.test(tradeData.driveLink)) {
            showMessage("Validation Error", "Please enter a valid Google Drive folder or file link.");
            return;
        }

        const tradeId = document.getElementById('trade-id')?.value;
        let successMessage = "Trade saved successfully!";
        try {
            if (tradeId) {
                tradeData.id = parseInt(tradeId); // Ensure ID is parsed as integer
                await updateEntry(STORE_TRADES, tradeData);
                successMessage = "Trade updated successfully!";
            } else {
                await addEntry(STORE_TRADES, tradeData);
            }

            await showMessage("Success", successMessage);
            form.reset(); // Clear the form
            // Clear selected emotions
            document.querySelectorAll('#emotion-emoji-grid .emotion-emoji-item').forEach(el => el.classList.remove('selected'));
            // Refresh allTrades cache
            allTrades = await getEntries(STORE_TRADES);
            showView('dashboard'); // Re-render the dashboard to reflect new data
        } catch (error) {
            console.error("Failed to save/update trade:", error);
            showMessage("Error", `Failed to save/update trade: ${error.message}.`);
        }
    }

    /**
     * Renders the View Trades table with search and filters.
     */
    async function renderViewTrades() {
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl mb-6 border border-zinc-700">
                <h2 class="text-2xl font-bold mb-5 text-indigo-400">Your Trade History</h2>
                <div class="flex flex-col md:flex-row gap-3 mb-5">
                    <input type="text" id="search-input" placeholder="Search instrument, strategy, notes..." class="flex-1 p-2 rounded-md bg-zinc-700 border border-zinc-600">
                    <select type="text" id="filter-strategy" class="p-2 rounded-md bg-zinc-700 border border-zinc-600 text-sm"></select>
                    <select type="text" id="filter-result" class="p-2 rounded-md bg-zinc-700 border border-zinc-600 text-sm"></select>
                    <input type="date" id="filter-start-date" class="p-2 rounded-md bg-zinc-700 border border-zinc-600 text-sm">
                    <input type="date" id="filter-end-date" class="p-2 rounded-md bg-zinc-700 border border-zinc-600 text-sm">
                    <button id="clear-filters" class="btn-secondary px-3 py-1 text-sm">Clear Filters</button>
                </div>
                <div id="calendar-view-container" class="bg-zinc-700 p-3 rounded-lg mb-5">
                    <div class="flex justify-between items-center mb-3">
                        <button id="prev-month-btn" class="btn-secondary px-2 py-1 text-sm"><i data-lucide="chevron-left"></i></button>
                        <h3 id="current-month-year" class="text-indigo-300 font-semibold text-lg"></h3>
                        <button id="next-month-btn" class="btn-secondary px-2 py-1 text-sm"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div id="calendar-view" class="grid grid-cols-7 gap-1 text-center text-xs">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
                <div id="trades-list" class="trade-table-container">
                    <table class="trade-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Instrument</th>
                                <th>Type</th>
                                <th>Strategy</th>
                                <th>Result</th>
                                <th>P&L (₹)</th>
                                <th>Emotions</th>
                                <th>Files</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body">
                            <!-- Trades will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="no-trades-message" class="text-center text-zinc-400 mt-4 hidden">No trades found matching your criteria.</p>
            </div>
        `;

        // Populate filters
        const filterStrategySelect = document.getElementById('filter-strategy');
        const filterResultSelect = document.getElementById('filter-result');

        filterStrategySelect.innerHTML = '<option value="">All Strategies</option>';
        STRATEGIES.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            filterStrategySelect.appendChild(opt);
        });

        filterResultSelect.innerHTML = '<option value="">All Results</option>';
        tradeResults.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r;
            opt.textContent = r;
            filterResultSelect.appendChild(opt);
        });

        const searchInput = document.getElementById('search-input');
        const filterStartDate = document.getElementById('filter-start-date');
        const filterEndDate = document.getElementById('filter-end-date');
        const clearFiltersButton = document.getElementById('clear-filters');

        // Calendar Navigation buttons
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            filterAndDisplayTrades(); // Re-render calendar and trades for new month
        });
        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            filterAndDisplayTrades(); // Re-render calendar and trades for new month
        });


        // Event listeners for filtering and searching
        searchInput.addEventListener('input', filterAndDisplayTrades);
        filterStrategySelect.addEventListener('change', filterAndDisplayTrades);
        filterResultSelect.addEventListener('change', filterAndDisplayTrades);
        filterStartDate.addEventListener('change', filterAndDisplayTrades);
        filterEndDate.addEventListener('change', filterAndDisplayTrades);
        clearFiltersButton.addEventListener('click', () => {
            searchInput.value = '';
            filterStrategySelect.value = '';
            filterResultSelect.value = '';
            filterStartDate.value = '';
            filterEndDate.value = '';
            currentCalendarDate = new Date(); // Reset calendar to current month
            filterAndDisplayTrades();
        });

        await filterAndDisplayTrades(); // Initial load of trades
        lucide.createIcons(); // Ensure icons are rendered
    }

    /**
     * Filters trades based on current criteria and displays them.
     */
    async function filterAndDisplayTrades() {
        // Re-fetch all trades from DB to ensure cache is fresh before filtering/displaying
        allTrades = await getEntries(STORE_TRADES);

        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const filterStrategy = document.getElementById('filter-strategy').value;
        const filterResult = document.getElementById('filter-result').value;
        const filterStartDate = document.getElementById('filter-start-date').value;
        const filterEndDate = document.getElementById('filter-end-date').value;

        let filteredTrades = allTrades.filter(trade => {
            const matchesSearch = searchInput === '' ||
                                  trade.instrument.toLowerCase().includes(searchInput) ||
                                  (trade.notes && trade.notes.toLowerCase().includes(searchInput)) ||
                                  (trade.tags && trade.tags.some(tag => tag.toLowerCase().includes(searchInput))) ||
                                  (trade.strategyUsed && trade.strategyUsed.toLowerCase().includes(searchInput));

            const matchesStrategy = filterStrategy === '' || trade.strategyUsed === filterStrategy;
            const matchesResult = filterResult === '' || trade.result === filterResult;

            const tradeDate = new Date(trade.entryDate);
            const matchesStartDate = filterStartDate === '' || tradeDate >= new Date(filterStartDate + 'T00:00:00'); // Add time to ensure correct comparison
            const matchesEndDate = filterEndDate === '' || tradeDate <= new Date(filterEndDate + 'T23:59:59'); // Add time to ensure correct comparison

            return matchesSearch && matchesStrategy && matchesResult && matchesStartDate && matchesEndDate;
        });

        displayTrades(filteredTrades);
        // Pass *all* trades for highlighting to calendar, but filter calendar view by current month
        renderCalendar(allTrades);
    }

    /**
     * Displays a list of trades in the table.
     * @param {Array<Object>} trades - The trades to display.
     */
    function displayTrades(trades) {
        const tbody = document.getElementById('trades-table-body');
        const noTradesMessage = document.getElementById('no-trades-message');
        tbody.innerHTML = ''; // Clear existing rows

        if (trades.length === 0) {
            noTradesMessage.classList.remove('hidden');
            return;
        } else {
            noTradesMessage.classList.add('hidden');
        }

        trades.sort((a, b) => new Date(b.entryDate) - new Date(a.entryDate)); // Sort by date descending

        trades.forEach(trade => {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-700 transition-colors duration-150";
            const pnlClass = trade.pnl >= 0 ? 'text-emerald-400' : 'text-red-400';

            // Map stored emotion names back to emojis
            const emotionEmojis = (trade.emotions || [])
                .map(emotionName => EMOTIONS.find(e => e.name === emotionName)?.emoji || '')
                .join(' ');


            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap">${trade.entryDate}</td>
                <td class="px-3 py-2 whitespace-nowrap">${trade.instrument}</td>
                <td class="px-3 py-2 whitespace-nowrap">${trade.type}</td>
                <td class="px-3 py-2 whitespace-nowrap">${trade.strategyUsed || 'N/A'}</td>
                <td class="px-3 py-2 whitespace-nowrap">${trade.result}</td>
                <td class="px-3 py-2 whitespace-nowrap ${pnlClass}">${formatRupee(trade.pnl)}</td>
                <td class="px-3 py-2 whitespace-nowrap">${emotionEmojis}</td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <a href="${trade.driveLink}" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:text-indigo-300 text-sm">
                        <i data-lucide="folder-output" class="inline-block align-middle mr-1"></i> Files
                    </a>
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-right">
                    <button class="text-blue-500 hover:text-blue-600 edit-trade-btn text-sm mr-2" data-id="${trade.id}">
                        <i data-lucide="edit-3" class="inline-block align-middle"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-600 delete-trade-btn text-sm" data-id="${trade.id}">
                        <i data-lucide="trash-2" class="inline-block align-middle"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Re-create lucide icons for newly added elements
        lucide.createIcons();

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-trade-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const tradeId = parseInt(event.currentTarget.dataset.id);
                const tradeToEdit = allTrades.find(t => t.id === tradeId);
                if (tradeToEdit) {
                    showView('add-trade', tradeToEdit); // Pass the trade object to renderAddTradeForm
                }
            });
        });

        // FIX: Re-attaching event listeners for delete buttons after re-rendering the table
        document.querySelectorAll('.delete-trade-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const tradeId = parseInt(event.currentTarget.dataset.id);
                const confirmDelete = await showMessage("Confirm Delete", "Are you sure you want to delete this trade entry?");
                if (confirmDelete) {
                    try {
                        await deleteEntry(STORE_TRADES, tradeId);
                        await showMessage("Deleted", "Trade deleted successfully.");
                        // After successful deletion, refresh the data and then re-render the current view
                        await filterAndDisplayTrades(); // This will re-fetch and re-display
                        const currentView = document.getElementById('app-content').dataset.currentView;
                        if (currentView === 'dashboard' || currentView === 'analytics') {
                            showView(currentView); // Refresh dashboard/analytics to reflect changes
                        }
                    } catch (error) {
                        console.error("Error deleting trade:", error);
                        showMessage("Error", "Failed to delete trade.");
                    }
                }
            });
        });
    }

    /**
     * Renders the calendar view.
     * @param {Array<Object>} allTrades - All trades for highlighting dates.
     */
    function renderCalendar(allTrades) {
        const calendarView = document.getElementById('calendar-view');
        const currentMonthYearHeader = document.getElementById('current-month-year');
        calendarView.innerHTML = ''; // Clear previous calendar

        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth(); // 0-indexed

        currentMonthYearHeader.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const daysInMonth = lastDayOfMonth.getDate();
        const startDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday

        // Map trade dates to a Set for quick lookup
        // Only trades within the current calendar month should determine highlighting
        const tradesInCurrentMonth = allTrades.filter(trade => {
            const tradeDate = new Date(trade.entryDate);
            return tradeDate.getFullYear() === year && tradeDate.getMonth() === month;
        });
        const tradeDatesInMonth = new Set(tradesInCurrentMonth.map(trade => trade.entryDate));

        // Day names
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'font-bold text-indigo-300';
            dayHeader.textContent = day;
            calendarView.appendChild(dayHeader);
        });

        // Empty cells for the start of the month
        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'p-1';
            calendarView.appendChild(emptyDiv);
        }

        // Days of the month
        const today = new Date(); // To highlight current day
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayDiv = document.createElement('div');
            dayDiv.className = `p-1 rounded-md cursor-pointer hover:bg-zinc-600 transition-colors duration-200`;

            if (tradeDatesInMonth.has(dateStr)) {
                dayDiv.classList.add('bg-indigo-700', 'text-white', 'font-bold', 'shadow-md');
                dayDiv.title = `Trades on ${dateStr}`;
            } else {
                dayDiv.classList.add('bg-zinc-700', 'text-zinc-300');
            }
            // Highlight today's date if it's in the current calendar month
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayDiv.classList.add('border-2', 'border-indigo-400');
            }

            dayDiv.textContent = day;
            // Add click listener to filter trades by the clicked date
            dayDiv.addEventListener('click', () => {
                document.getElementById('filter-start-date').value = dateStr;
                document.getElementById('filter-end-date').value = dateStr;
                filterAndDisplayTrades();
            });
            calendarView.appendChild(dayDiv);
        }
        lucide.createIcons();
    }


    /**
     * Renders the Performance Dashboard (main overview).
     */
    async function renderDashboard() {
        destroyAllCharts(); // Destroy any existing charts
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl border border-zinc-700">
                <h2 class="text-2xl font-bold mb-5 text-indigo-400">Overall Performance</h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md text-center border border-zinc-600">
                        <h3 class="text-indigo-300 text-base font-semibold">Total Trades</h3>
                        <p id="total-trades" class="text-3xl font-bold text-white mt-1">0</p>
                    </div>
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md text-center border border-zinc-600">
                        <h3 class="text-indigo-300 text-base font-semibold">Net P&L (₹)</h3>
                        <p id="net-pnl" class="text-3xl font-bold text-white mt-1">₹0.00</p>
                    </div>
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md text-center border border-zinc-600">
                        <h3 class="text-indigo-300 text-base font-semibold">Win Rate</h3>
                        <p id="win-rate" class="text-3xl font-bold text-white mt-1">0.00%</p>
                    </div>
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md text-center border border-zinc-600">
                        <h3 class="text-indigo-300 text-base font-semibold">Avg. P&L / Trade</h3>
                        <p id="avg-pnl-trade" class="text-3xl font-bold text-white mt-1">₹0.00</p>
                    </div>
                </div>

                <div class="bg-zinc-700 p-5 rounded-lg shadow-md border border-zinc-600">
                    <h3 class="text-indigo-300 text-xl font-semibold mb-4">Equity Curve</h3>
                    <div class="flex flex-wrap gap-2 mb-4 justify-center"> <!-- Added justify-center for compactness -->
                        <button class="btn-toggle active" data-filter="all">All Time</button>
                        <button class="btn-toggle" data-filter="weekly">Weekly</button>
                        <button class="btn-toggle" data-filter="monthly">Monthly</button>
                        <button class="btn-toggle" data-filter="quarterly">Quarterly</button>
                        <button class="btn-toggle" data-filter="yearly">Yearly</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="equity-chart"></canvas>
                    </div>
                </div>
            </div>
        `;

        allTrades = await getEntries(STORE_TRADES); // Ensure trades are fresh
        updateDashboardStats(allTrades);
        renderEquityCurve(allTrades, 'all'); // Initial render of equity curve

        document.querySelectorAll('.btn-toggle').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                renderEquityCurve(allTrades, this.dataset.filter);
            });
        });
    }

    /**
     * Renders the Advanced Analytics page with all detailed charts.
     */
    async function renderAnalytics() {
        destroyAllCharts(); // Destroy any existing charts
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl border border-zinc-700">
                <h2 class="text-2xl font-bold mb-5 text-indigo-400">Advanced Analytics</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-zinc-700 p-5 rounded-lg shadow-md border border-zinc-600 chart-bg">
                        <h3 class="text-indigo-300 text-xl font-semibold mb-4">Strategy Breakdown</h3>
                        <div class="chart-container"><canvas id="strategy-chart"></canvas></div>
                    </div>
                    <div class="bg-zinc-700 p-5 rounded-lg shadow-md border border-zinc-600 chart-bg">
                        <h3 class="text-indigo-300 text-xl font-semibold mb-4">Emotion Breakdown</h3>
                        <div class="chart-container"><canvas id="emotion-chart"></canvas></div>
                    </div>
                    <div class="bg-zinc-700 p-5 rounded-lg shadow-md border border-zinc-600 chart-bg">
                        <h3 class="text-indigo-300 text-xl font-semibold mb-4">P&L Distribution by Type</h3>
                        <div class="chart-container"><canvas id="type-chart"></canvas></div>
                    </div>
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md border border-zinc-600 chart-bg">
                        <h4 class="text-indigo-300 text-lg font-semibold mb-2">Daily P&L</h4>
                        <div class="chart-container"><canvas id="daily-pnl-chart"></canvas></div>
                    </div>
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md border border-zinc-600 chart-bg">
                        <h4 class="text-indigo-300 text-lg font-semibold mb-2">Weekly P&L</h4>
                        <div class="chart-container"><canvas id="weekly-pnl-chart"></canvas></div>
                    </div>
                    <div class="bg-zinc-700 p-4 rounded-lg shadow-md border border-zinc-600 chart-bg">
                        <h4 class="text-indigo-300 text-lg font-semibold mb-2">Reflections Logged Over Time</h4>
                        <div class="chart-container"><canvas id="reflections-over-time-chart"></canvas></div>
                    </div>
                </div>
            </div>
        `;
        allTrades = await getEntries(STORE_TRADES); // Ensure trades are fresh
        allReflections = await getEntries(STORE_REFLECTIONS); // Ensure reflections are fresh

        renderAllDetailedCharts(allTrades, allReflections);
    }

    /**
     * Updates the dashboard statistical figures.
     * @param {Array<Object>} trades - The array of trade objects.
     */
    function updateDashboardStats(trades) {
        const totalTrades = trades.length;
        const totalPnl = trades.reduce((sum, trade) => sum + trade.pnl, 0);
        const winTrades = trades.filter(trade => trade.result === 'Win').length;
        const lossTrades = trades.filter(trade => trade.result === 'Loss').length;

        const winRate = totalTrades > 0 ? (winTrades / totalTrades) * 100 : 0;
        const avgPnlPerTrade = totalTrades > 0 ? totalPnl / totalTrades : 0;

        document.getElementById('total-trades').textContent = totalTrades;
        document.getElementById('net-pnl').textContent = formatRupee(totalPnl);
        document.getElementById('net-pnl').className = `text-3xl font-bold mt-1 ${totalPnl >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
        document.getElementById('win-rate').textContent = `${winRate.toFixed(2)}%`;
        document.getElementById('avg-pnl-trade').textContent = formatRupee(avgPnlPerTrade);
    }

    /**
     * Renders the Equity Curve chart with date filtering.
     * @param {Array<Object>} trades - The array of trade objects.
     * @param {string} filterType - 'all', 'weekly', 'monthly', 'quarterly', 'yearly'.
     */
    function renderEquityCurve(trades, filterType) {
        Chart.getChart('equity-chart')?.destroy(); // Destroy existing chart

        const isDarkTheme = document.documentElement.classList.contains('dark');
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-text-color').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
        const tooltipBgColor = isDarkTheme ? 'rgba(31, 41, 55, 0.8)' : 'rgba(255,255,255,0.8)';
        const tooltipBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();


        let filteredTrades = [...trades].sort((a, b) => new Date(a.entryDate) - new Date(b.entryDate));

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-indexed

        if (filterType !== 'all') {
            filteredTrades = filteredTrades.filter(trade => {
                const tradeDate = new Date(trade.entryDate);
                switch (filterType) {
                    case 'weekly':
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                        return tradeDate >= startOfWeek;
                    case 'monthly':
                        return tradeDate.getMonth() === month && tradeDate.getFullYear() === year;
                    case 'quarterly':
                        const currentQuarter = Math.floor(month / 3);
                        return Math.floor(tradeDate.getMonth() / 3) === currentQuarter && tradeDate.getFullYear() === year;
                    case 'yearly':
                        return tradeDate.getFullYear() === year;
                    default:
                        return true;
                }
            });
        }

        const equityLabels = filteredTrades.map(trade => trade.entryDate);
        let cumulativePnl = 0;
        const equityData = filteredTrades.map(trade => {
            cumulativePnl += trade.pnl;
            return cumulativePnl;
        });

        const ctx = document.getElementById('equity-chart');
        if (!ctx) return; // Exit if canvas not found

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: equityLabels,
                datasets: [{
                    label: 'Cumulative P&L',
                    data: equityData,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim(),
                    backgroundColor: isDarkTheme ? 'rgba(99, 102, 241, 0.2)' : 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim(),
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Essential for fixed height containers
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: tooltipBgColor,
                        borderColor: tooltipBorderColor,
                        borderWidth: 1,
                        titleColor: textColor,
                        bodyColor: textColor,
                    },
                    datalabels: { display: false } // Disable datalabels for line chart
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    }


    /**
     * Renders all detailed charts for the Advanced Analytics page.
     * @param {Array<Object>} trades - The array of trade objects.
     * @param {Array<Object>} reflections - The array of reflection objects.
     */
    function renderAllDetailedCharts(trades, reflections) {
        destroyAllCharts(); // Destroy all charts explicitly before rendering new ones

        // Colors for charts based on theme
        const isDarkTheme = document.documentElement.classList.contains('dark');
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-text-color').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
        const tooltipBgColor = isDarkTheme ? 'rgba(31, 41, 55, 0.8)' : 'rgba(255,255,255,0.8)';
        const tooltipBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();


        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false, // Crucial for fixed height
            plugins: {
                legend: {
                    labels: { color: textColor }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: tooltipBgColor,
                    borderColor: tooltipBorderColor,
                    borderWidth: 1,
                    titleColor: textColor,
                    bodyColor: textColor,
                },
                datalabels: { display: false } // Default to false, enable only for pie/doughnut if needed
            },
            scales: {
                x: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                },
                y: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                }
            }
        };

        // Strategy Breakdown Data
        const strategyMap = {};
        trades.forEach(trade => {
            strategyMap[trade.strategyUsed] = (strategyMap[trade.strategyUsed] || 0) + 1;
        });
        const strategyLabels = Object.keys(strategyMap);
        const strategyData = Object.values(strategyMap);

        new Chart(document.getElementById('strategy-chart'), {
            type: 'doughnut',
            data: {
                labels: strategyLabels,
                datasets: [{
                    data: strategyData,
                    backgroundColor: [
                        '#6366f1', '#a855f7', '#f472b6', '#ef4444', '#f59e0b',
                        '#eab308', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#fb923c' // Added one more color
                    ],
                    hoverOffset: 8
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: {
                    ...defaultChartOptions.plugins,
                    legend: {
                        position: 'right',
                        labels: { color: textColor }
                    },
                    datalabels: { // Enable datalabels for doughnut
                        color: textColor,
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => { sum += data; });
                            let percentage = (value * 100 / sum).toFixed(1) + '%';
                            return percentage;
                        },
                        font: { weight: 'bold' }
                    }
                }
            }
        });

        // Emotion Breakdown Data
        const emotionMap = {};
        trades.forEach(trade => {
            if (trade.emotions) {
                trade.emotions.forEach(emotionName => {
                    emotionMap[emotionName] = (emotionMap[emotionName] || 0) + 1;
                });
            }
        });
        const emotionLabels = Object.keys(emotionMap);
        const emotionData = Object.values(emotionMap);

        new Chart(document.getElementById('emotion-chart'), {
            type: 'bar',
            data: {
                labels: emotionLabels,
                datasets: [{
                    label: 'Emotion Count',
                    data: emotionData,
                    backgroundColor: '#a855f7',
                    borderColor: '#9333ea',
                    borderWidth: 1
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { legend: { display: false } }, // Override legend to hide for bar chart
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });

        // P&L Distribution by Type Data
        const typePnlMap = {};
        trades.forEach(trade => {
            typePnlMap[trade.type] = (typePnlMap[trade.type] || 0) + trade.pnl;
        });
        const typeLabels = Object.keys(typePnlMap);
        const typeData = Object.values(typePnlMap);

        new Chart(document.getElementById('type-chart'), {
            type: 'bar',
            data: {
                labels: typeLabels,
                datasets: [{
                    label: 'Net P&L',
                    data: typeData,
                    backgroundColor: typeData.map(pnl => pnl >= 0 ? '#22c55e' : '#ef4444'),
                    borderColor: typeData.map(pnl => pnl >= 0 ? '#16a34a' : '#dc2626'),
                    borderWidth: 1
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });

        // --- Daily and Weekly P&L Charts ---
        const dailyPnl = {};
        const weeklyPnl = {};

        trades.forEach(trade => {
            const date = new Date(trade.entryDate);
            const dateString = trade.entryDate; // YYYY-MM-DD
            const dayOfWeek = date.getDay(); // 0 for Sunday, 6 for Saturday
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - dayOfWeek); // Go back to Sunday (start of week)
            const weekStartDateString = weekStart.toISOString().split('T')[0];

            dailyPnl[dateString] = (dailyPnl[dateString] || 0) + trade.pnl;
            weeklyPnl[weekStartDateString] = (weeklyPnl[weekStartDateString] || 0) + trade.pnl;
        });

        // Sort and prepare daily data
        const sortedDailyLabels = Object.keys(dailyPnl).sort();
        const sortedDailyData = sortedDailyLabels.map(date => dailyPnl[date]);

        new Chart(document.getElementById('daily-pnl-chart'), {
            type: 'bar',
            data: {
                labels: sortedDailyLabels,
                datasets: [{
                    label: 'Daily P&L',
                    data: sortedDailyData,
                    backgroundColor: sortedDailyData.map(pnl => pnl >= 0 ? '#22c55e' : '#ef4444'),
                    borderColor: sortedDailyData.map(pnl => pnl >= 0 ? '#16a34a' : '#dc2626'),
                    borderWidth: 1
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: textColor, maxRotation: 45, minRotation: 45 },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });

        // Sort and prepare weekly data
        const sortedWeeklyLabels = Object.keys(weeklyPnl).sort();
        const sortedWeeklyData = sortedWeeklyLabels.map(date => weeklyPnl[date]);

        new Chart(document.getElementById('weekly-pnl-chart'), {
            type: 'bar',
            data: {
                labels: sortedWeeklyLabels,
                datasets: [{
                    label: 'Weekly P&L',
                    data: sortedWeeklyData,
                    backgroundColor: sortedWeeklyData.map(pnl => pnl >= 0 ? '#14b8a6' : '#f59e0b'),
                    borderColor: sortedWeeklyData.map(pnl => pnl >= 0 ? '#0d9488' : '#d97706'),
                    borderWidth: 1
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: textColor, maxRotation: 45, minRotation: 45 },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });

        // --- Reflection Metrics: Reflections Logged Over Time ---
        const reflectionsByMonth = {};
        reflections.forEach(reflection => {
            const date = new Date(reflection.date);
            const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            reflectionsByMonth[monthYear] = (reflectionsByMonth[monthYear] || 0) + 1;
        });

        const sortedReflectionMonths = Object.keys(reflectionsByMonth).sort();
        const reflectionCounts = sortedReflectionMonths.map(month => reflectionsByMonth[month]);

        new Chart(document.getElementById('reflections-over-time-chart'), {
            type: 'bar',
            data: {
                labels: sortedReflectionMonths,
                datasets: [{
                    label: 'Reflections Count',
                    data: reflectionCounts,
                    backgroundColor: '#3b82f6',
                    borderColor: '#2563eb',
                    borderWidth: 1
                }]
            },
            options: {
                ...defaultChartOptions,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: textColor, maxRotation: 45, minRotation: 45 },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    }


    /**
     * Renders the Reflections page with improved UI.
     */
    async function renderReflections() {
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl mb-6 border border-zinc-700">
                <h2 class="text-2xl font-bold mb-5 text-indigo-400">Trading Reflections</h2>
                <form id="reflection-entry-form" class="grid grid-cols-1 gap-6">

                    <div class="form-section">
                        <h3 class="form-section-title flex items-center"><i data-lucide="calendar" class="mr-2"></i> Reflection Date</h3>
                        <div class="input-group">
                            <i data-lucide="calendar" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                            <input type="date" id="reflection-date" name="reflectionDate" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title flex items-center"><i data-lucide="alert-circle" class="mr-2"></i> Mistake Log</h3>
                        <div class="input-group items-start">
                            <i data-lucide="target" class="text-zinc-400 mr-3 mt-2 flex-shrink-0"></i>
                            <textarea id="mistake-log" name="mistakeLog" rows="3" placeholder="What went wrong or could be improved?"></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title flex items-center"><i data-lucide="lightbulb" class="mr-2"></i> Learnings</h3>
                        <div class="input-group items-start">
                            <i data-lucide="lightbulb" class="text-zinc-400 mr-3 mt-2 flex-shrink-0"></i>
                            <textarea id="learnings" name="learnings" rows="3" placeholder="What did you learn from this trade/period?"></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title flex items-center"><i data-lucide="zap" class="mr-2"></i> Actionable Steps/Goals</h3>
                        <div class="input-group items-start">
                            <i data-lucide="zap" class="text-zinc-400 mr-3 mt-2 flex-shrink-0"></i>
                            <textarea id="actionable-steps" name="actionableSteps" rows="3" placeholder="What actionable steps will you take next?"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end mt-2 col-span-full">
                        <button type="submit" class="btn-primary">Save Reflection</button>
                    </div>
                </form>

                <h3 class="text-xl font-bold mb-4 text-indigo-400">Past Reflections</h3>
                <div id="reflections-list" class="space-y-4">
                    <p class="text-zinc-400 text-center" id="no-reflections-message">No reflections logged yet.</p>
                    <!-- Reflections will be loaded here -->
                </div>
            </div>
        `;
        lucide.createIcons();
        document.getElementById('reflection-entry-form').addEventListener('submit', handleReflectionFormSubmit);
        document.getElementById('reflection-date').value = new Date().toISOString().split('T')[0];
        await displayReflections();
    }

    /**
     * Handles the submission of the reflection entry form.
     * @param {Event} event - The form submission event.
     */
    async function handleReflectionFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const reflectionData = {
            date: formData.get('reflectionDate'),
            mistakeLog: formData.get('mistakeLog'),
            learnings: formData.get('learnings'),
            actionableSteps: formData.get('actionableSteps')
        };

        try {
            await addEntry(STORE_REFLECTIONS, reflectionData);
            await showMessage("Success", "Reflection saved successfully!");
            form.reset();
            document.getElementById('reflection-date').value = new Date().toISOString().split('T')[0]; // Reset date
            allReflections = await getEntries(STORE_REFLECTIONS); // Refresh cached reflections
            await displayReflections(); // Re-display list
            showView('analytics'); // Update analytics if visible
        } catch (error) {
            console.error("Failed to save reflection:", error);
            showMessage("Error", "Failed to save reflection.");
        }
    }

    /**
     * Displays all reflections.
     */
    async function displayReflections() {
        allReflections = await getEntries(STORE_REFLECTIONS); // Ensure fresh data
        const reflectionsList = document.getElementById('reflections-list');
        const noReflectionsMessage = document.getElementById('no-reflections-message');
        reflectionsList.innerHTML = ''; // Clear existing

        if (allReflections.length === 0) {
            noReflectionsMessage.classList.remove('hidden');
            return;
        } else {
            noReflectionsMessage.classList.add('hidden');
        }

        allReflections.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

        allReflections.forEach(reflection => {
            const div = document.createElement('div');
            div.className = "reflection-entry border border-zinc-700";
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-lg text-indigo-300">${reflection.date}</span>
                    <button class="text-red-500 hover:text-red-600 delete-reflection-btn text-sm" data-id="${reflection.id}">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
                ${reflection.mistakeLog ? `<p class="text-zinc-300 mb-1 text-sm"><span class="font-semibold text-indigo-200">Mistake Log:</span> ${reflection.mistakeLog}</p>` : ''}
                ${reflection.learnings ? `<p class="text-zinc-300 mb-1 text-sm"><span class="font-semibold text-indigo-200">Learnings:</span> ${reflection.learnings}</p>` : ''}
                ${reflection.actionableSteps ? `<p class="text-zinc-300 text-sm"><span class="font-semibold text-indigo-200">Actionable Steps:</span> ${reflection.actionableSteps}</p>` : ''}
            `;
            reflectionsList.appendChild(div);
        });
        lucide.createIcons();

        document.querySelectorAll('.delete-reflection-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const reflectionId = parseInt(event.currentTarget.dataset.id);
                const confirmDelete = await showMessage("Confirm Delete", "Are you sure you want to delete this reflection entry?");
                if (confirmDelete) {
                    try {
                        await deleteEntry(STORE_REFLECTIONS, reflectionId);
                        // allReflections will be refreshed by displayReflections, no need to filter here
                        await showMessage("Deleted", "Reflection deleted successfully.");
                        await displayReflections(); // Re-display list after deletion
                        // Ensure analytics also reflect deletion if it was the active view
                        const currentView = document.getElementById('app-content').dataset.currentView;
                        if (currentView === 'analytics') {
                            showView(currentView);
                        }
                    } catch (error) {
                        console.error("Error deleting reflection:", error);
                        showMessage("Error", "Failed to delete reflection.");
                    }
                }
            });
        });
    }


    /**
     * Renders the Settings page with Export/Import and Delete All Data.
     */
    function renderSettings() {
        const appContent = document.getElementById('app-content');
        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl mb-6 border border-zinc-700">
                <h2 class="text-2xl font-bold mb-5 text-indigo-400">Settings</h2>

                <div class="mb-6 bg-zinc-700 p-4 rounded-lg border border-zinc-600">
                    <h3 class="text-xl font-semibold mb-3 text-zinc-300">Data Management</h3>
                    <p class="text-zinc-400 mb-4 text-sm">You can export your trading journal data as a JSON file for backup, or import data to restore it.</p>
                    <div class="flex flex-wrap gap-4">
                        <button id="export-data-btn" class="btn-primary flex items-center text-sm"><i data-lucide="download" class="mr-2"></i> Export Data (.json)</button>
                        <label for="import-file-input" class="btn-secondary flex items-center cursor-pointer text-sm">
                            <i data-lucide="upload" class="mr-2"></i> Import Data (.json)
                        </label>
                        <input type="file" id="import-file-input" accept=".json" class="hidden">
                    </div>
                </div>

                <div class="mb-6 bg-zinc-700 p-4 rounded-lg border border-zinc-600">
                    <h3 class="text-xl font-semibold mb-3 text-zinc-300">Theme Settings</h3>
                    <p class="text-zinc-400 mb-4 text-sm">Toggle between light and dark themes.</p>
                    <button id="settings-theme-toggle" class="btn-primary flex items-center text-sm"><i data-lucide="sun-moon" class="mr-2"></i> Toggle Theme</button>
                </div>

                <div class="mb-6 bg-zinc-700 p-4 rounded-lg border border-zinc-600">
                    <h3 class="text-xl font-semibold mb-3 text-red-400">Danger Zone</h3>
                    <p class="text-zinc-400 mb-4 text-sm">Permanently delete ALL your trading journal data from your browser. This action cannot be undone.</p>
                    <button id="delete-all-data-btn" class="btn-danger flex items-center text-sm"><i data-lucide="alert-triangle" class="mr-2"></i> Delete All Data</button>
                </div>
            `;
        lucide.createIcons(); // Ensure icons are rendered

        document.getElementById('export-data-btn').addEventListener('click', exportData);
        document.getElementById('import-file-input').addEventListener('change', importData);
        document.getElementById('settings-theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('delete-all-data-btn').addEventListener('click', deleteAllData);
    }

    /**
     * Exports all trade data as a JSON file.
     */
    async function exportData() {
        try {
            const trades = await getEntries(STORE_TRADES);
            const reflections = await getEntries(STORE_REFLECTIONS);
            const combinedData = { trades: trades, reflections: reflections };

            const dataStr = JSON.stringify(combinedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_journal_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Success", "Your data has been exported!");
        } catch (error) {
            console.error("Error exporting data:", error);
            showMessage("Error", "Failed to export data. Please try again.");
        }
    }

    /**
     * Imports trade data from a JSON file.
     * @param {Event} event - The file input change event.
     */
    async function importData(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                const importedTrades = importedData.trades;
                const importedReflections = importedData.reflections;

                if (!Array.isArray(importedTrades) || !Array.isArray(importedReflections)) {
                    showMessage("Import Error", "Invalid file format. Please upload a JSON object with 'trades' and 'reflections' arrays.");
                    return;
                }

                // Clear existing data before importing new data
                await clearStore(STORE_TRADES);
                await clearStore(STORE_REFLECTIONS);

                const tradeTransaction = db.transaction([STORE_TRADES], 'readwrite');
                const tradeObjectStore = tradeTransaction.objectStore(STORE_TRADES);
                for (const trade of importedTrades) {
                    const tradeToStore = { ...trade };
                    delete tradeToStore.id; // Let IndexedDB auto-increment new IDs
                    tradeObjectStore.add(tradeToStore);
                }

                const reflectionTransaction = db.transaction([STORE_REFLECTIONS], 'readwrite');
                const reflectionObjectStore = reflectionTransaction.objectStore(STORE_REFLECTIONS);
                for (const reflection of importedReflections) {
                    const reflectionToStore = { ...reflection };
                    delete reflectionToStore.id; // Let IndexedDB auto-increment new IDs
                    reflectionObjectStore.add(reflectionToStore);
                }

                tradeTransaction.oncomplete = reflectionTransaction.oncomplete = async () => {
                    await showMessage("Success", "Data imported successfully!");
                    allTrades = await getEntries(STORE_TRADES); // Re-fetch all trades to update cache
                    allReflections = await getEntries(STORE_REFLECTIONS); // Re-fetch all reflections to update cache

                    // Re-render current view to reflect new data
                    const currentView = document.getElementById('app-content').dataset.currentView;
                    showView(currentView);
                };

                tradeTransaction.onerror = reflectionTransaction.onerror = (error) => {
                    console.error("Error during import transaction:", error);
                    showMessage("Import Error", "Failed to import some data. Check console for details.");
                };

            } catch (error) {
                console.error("Error parsing import file:", error);
                showMessage("Import Error", "Could not read the file. Ensure it's a valid JSON format.");
            }
        };
        reader.readAsText(file);
    }

    /**
     * Deletes all data from both trade and reflection stores.
     */
    async function deleteAllData() {
        const confirmDelete = await showMessage(
            "Confirm Permanent Delete",
            "This will permanently delete ALL your trading journal data. This action cannot be undone. Are you absolutely sure?"
        );

        if (confirmDelete) {
            try {
                await clearStore(STORE_TRADES);
                await clearStore(STORE_REFLECTIONS);
                allTrades = []; // Clear local cache
                allReflections = []; // Clear local cache
                await showMessage("Data Deleted", "All trading journal data has been successfully deleted.");
                showView('dashboard'); // Go back to an empty dashboard
            } catch (error) {
                console.error("Error deleting all data:", error);
                showMessage("Error", "Failed to delete all data. Please try again.");
            }
        }
    }


    /**
     * Renders the Lot Size Calculator page (now Sectors HawkView 🦅).
     */
    function renderLotSizeCalculator() {
        const appContent = document.getElementById('app-content');
        // Use the predefined FOHAWKVIEW_SECTORS for the filter dropdown
        const allSectors = ["All Stocks", ...FOHAWKVIEW_SECTORS]; // Add "All Stocks" option

        appContent.innerHTML = `
            <div class="bg-zinc-800 rounded-lg p-6 shadow-xl mb-6 border border-zinc-700">
                <div class="flex items-center mb-5"> <!-- Flex container for title and button -->
                    <h2 class="text-2xl font-bold text-indigo-400">Sectors HawkView 🦅</h2>
                    <button id="scanModeToggle" class="scan-mode-toggle">
                        <span class="scan-icon">🔍</span>
                        <span>Scan Mode</span>
                    </button>
                </div>
                <p class="text-zinc-300 mb-4">Calculate estimated Net P&L for various instruments.</p>

                <div class="flex flex-col md:flex-row gap-3 mb-5">
                    <div class="input-group flex-1">
                        <i data-lucide="search" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                        <input type="text" id="lot-calculator-search" placeholder="Search by Company or Symbol" class="w-full">
                    </div>
                    <div class="input-group flex-1">
                        <i data-lucide="filter" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                        <select id="filter-sector" class="w-full text-sm">
                            ${allSectors.map(sector => `<option value="${sector === 'All Stocks' ? '' : sector}">${sector}</option>`).join('')}
                        </select>
                    </div>
                    <div class="input-group flex-1">
                        <i data-lucide="clipboard-type" class="text-zinc-400 mr-3 flex-shrink-0"></i>
                        <select id="calc-trade-type" class="w-full text-sm">
                            <option value="equity_intraday">Equity Intraday</option>
                            <option value="equity_delivery">Equity Delivery</option>
                            <option value="futures">Futures</option>
                            <option value="options">Options</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mb-4">
                    <button id="add-custom-row-btn" class="btn-secondary flex items-center text-sm">
                        <i data-lucide="plus-circle" class="mr-2"></i> Add Custom Instrument
                    </button>
                    <button id="export-calc-csv-btn" class="btn-secondary flex items-center text-sm">
                        <i data-lucide="download" class="mr-2"></i> Export CSV
                    </button>
                </div>

                <div class="trade-table-container">
                    <table class="trade-table">
                        <thead>
                            <tr>
                                <th>S.No.</th>
                                <th>Company</th>
                                <th>Symbol</th>
                                <th>Sector(s)</th>
                                <th>Entry ₹</th>
                                <th>Exit ₹</th>
                                <th>Lot Size</th>
                                <th>Lots Taken</th>
                                <th>Deploy Cap ₹</th>
                                <th>Gross P&L ₹</th>
                                <th>Charges ₹</th>
                                <th>Net P&L ₹</th>
                            </tr>
                        </thead>
                        <tbody id="lot-size-table-body">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="no-lot-data-message" class="text-center text-zinc-400 mt-4 hidden">No matching instruments found.</p>
            </div>
        `;
        lucide.createIcons();

        const searchInput = document.getElementById('lot-calculator-search');
        const filterSectorSelect = document.getElementById('filter-sector');
        const tradeTypeSelect = document.getElementById('calc-trade-type');
        const addCustomRowBtn = document.getElementById('add-custom-row-btn');
        const exportCalcCsvBtn = document.getElementById('export-calc-csv-btn');

        // Scan Mode button specific initialization
        const scanModeToggle = document.getElementById('scanModeToggle');
        // Load saved state for scanModeActive and newTabModeActive
        scanModeActive = localStorage.getItem('scanModeActive') === 'true';
        newTabModeActive = localStorage.getItem('newTabModeActive') === 'true';

        if (scanModeToggle) {
            scanModeToggle.classList.toggle('active', scanModeActive || newTabModeActive); // Active if either is on
        }
        scanModeToggle.addEventListener('click', toggleScanMode);
        updateScanModeButtonText(); // Set initial text


        searchInput.addEventListener('input', filterAndDisplayLotSizes);
        filterSectorSelect.addEventListener('change', filterAndDisplayLotSizes);
        tradeTypeSelect.addEventListener('change', filterAndDisplayLotSizes); // Recalculate all P&L when trade type changes
        addCustomRowBtn.addEventListener('click', addCustomLotSizeRow);
        exportCalcCsvBtn.addEventListener('click', exportLotSizeTableAsCSV);

        filterAndDisplayLotSizes(); // Initial display
        updateSymbolCellStyling(); // Apply initial styling based on loaded scanModeActive
    }

    /**
     * Calculates and updates P&L, Charges, and Net P&L for a specific table row.
     * @param {HTMLElement} row - The table row element.
     */
    function updateRowCalculations(row) {
        const entryPrice = parseFloat(row.querySelector('.entry-price-input').value) || 0;
        const exitPrice = parseFloat(row.querySelector('.exit-price-input').value) || 0;
        // For custom rows, lotSize is editable, for others it's fixed text
        const lotSizeElement = row.querySelector('.lot-size-display');
        const lotSize = parseFloat(lotSizeElement.tagName === 'INPUT' ? lotSizeElement.value : lotSizeElement.textContent) || 1;
        const lotsTaken = parseFloat(row.querySelector('.lots-taken-input').value) || 0;

        const currentTradeType = document.getElementById('calc-trade-type').value;

        const grossPnl = (exitPrice - entryPrice) * lotSize * lotsTaken; // Gross P&L is per lot, then multiplied by lots taken
        const charges = calculateBrokerageAndTaxes(currentTradeType, entryPrice, exitPrice, lotsTaken, lotSize); // Pass lotsTaken and lotSize
        const netPnl = grossPnl - charges.totalCharges;
        const deployedCapital = entryPrice * lotSize * lotsTaken;

        row.querySelector('.gross-pnl-display').textContent = formatRupee(grossPnl);
        row.querySelector('.gross-pnl-display').classList.toggle('text-emerald-400', grossPnl >= 0);
        row.querySelector('.gross-pnl-display').classList.toggle('text-red-400', grossPnl < 0);

        row.querySelector('.charges-display').textContent = formatRupee(charges.totalCharges);
        row.querySelector('.net-pnl-display').textContent = formatRupee(netPnl);
        row.querySelector('.net-pnl-display').classList.toggle('text-emerald-400', netPnl >= 0);
        row.querySelector('.net-pnl-display').classList.toggle('text-red-400', netPnl < 0);
        row.querySelector('.deployed-capital-display').textContent = formatRupee(deployedCapital);
    }

    /**
     * Adds event listeners to a new table row for calculations and inline editing.
     * @param {HTMLElement} row - The table row element.
     */
    function addRowEventListeners(row) {
        const inputs = row.querySelectorAll('.entry-price-input, .exit-price-input, .lots-taken-input');
        inputs.forEach(input => {
            input.addEventListener('input', () => updateRowCalculations(row));
        });

        // Handle lot size input for custom rows
        const lotSizeInput = row.querySelector('.lot-size-input');
        if (lotSizeInput) {
            lotSizeInput.addEventListener('input', () => updateRowCalculations(row));
        }

        // Symbol cell should NOT be contenteditable
        const symbolCell = row.querySelector('.symbol-cell');
        if (symbolCell) {
            symbolCell.setAttribute('contenteditable', 'false'); // Ensure it's not editable

            let hoverTimeout;
            symbolCell.addEventListener('mouseover', () => {
                // Only open chart if either scanModeActive OR newTabModeActive is true
                if (scanModeActive || newTabModeActive) {
                    const ticker = symbolCell.textContent.trim();
                    // Delay opening the popup slightly to avoid flickering on quick mouse movements
                    hoverTimeout = setTimeout(() => {
                        openTradingViewWindow(ticker); // Call the unified function
                    }, 300); // 300ms delay
                }
            });
            symbolCell.addEventListener('mouseout', () => {
                clearTimeout(hoverTimeout); // Clear any pending hover
                // DO NOT close the window here. It should remain open until manually closed.
            });
        }
    }

    /**
     * Filters and displays lot size data (now Sectors HawkView 🦅 data).
     */
    function filterAndDisplayLotSizes() {
        const query = document.getElementById('lot-calculator-search').value.toLowerCase();
        const selectedSector = document.getElementById('filter-sector').value; // Empty string for "All Stocks"
        const tbody = document.getElementById('lot-size-table-body');
        const noDataMessage = document.getElementById('no-lot-data-message');
        tbody.innerHTML = '';

        let filtered = INSTRUMENTS_AND_LOT_SIZES.filter(item =>
            (item.company.toLowerCase().includes(query) || item.symbol.toLowerCase().includes(query)) &&
            (selectedSector === '' || (item.sectors && item.sectors.includes(selectedSector))) // Check if sectors array includes the selected sector
        );
        
        // console.log(`Filtered stocks for query "${query}" and sector "${selectedSector}": ${filtered.length}`); // Removed console log


        if (filtered.length === 0) {
            noDataMessage.classList.remove('hidden');
        } else {
            noDataMessage.classList.add('hidden');
            filtered.sort((a, b) => a.symbol.localeCompare(b.symbol)); // Sort by symbol

            filtered.forEach((item, index) => {
                const row = tbody.insertRow();
                // Map stored emotion names back to emojis
                const displaySectors = (item.sectors || [])
                    .map(sectorName => sectorName.replace('NIFTY ', '')) // Remove "NIFTY " prefix
                    .join(', ');

                row.innerHTML = `
                    <td class="px-3 py-2">${index + 1}</td>
                    <td class="px-3 py-2 editable-cell" contenteditable="true" data-field="company">${item.company}</td>
                    <td class="px-3 py-2 symbol-cell" contenteditable="false" data-field="symbol">${item.symbol}</td>
                    <td class="px-3 py-2 editable-cell" contenteditable="true" data-field="sector">${displaySectors}</td>
                    <td class="px-3 py-2"><input type="number" step="0.01" value="0" class="entry-price-input editable-cell input-cell"></td>
                    <td class="px-3 py-2"><input type="number" step="0.01" value="0" class="exit-price-input editable-cell input-cell"></td>
                    <td class="px-3 py-2 lot-size-display">${item.lotSize}</td>
                    <td class="px-3 py-2"><input type="number" value="1" class="lots-taken-input editable-cell input-cell"></td>
                    <td class="px-3 py-2 deployed-capital-display text-right">₹0.00</td>
                    <td class="px-3 py-2 gross-pnl-display text-right">₹0.00</td>
                    <td class="px-3 py-2 charges-display text-right">₹0.00</td>
                    <td class="px-3 py-2 net-pnl-display font-bold text-right">₹0.00</td>
                `;
                addRowEventListeners(row);
                updateRowCalculations(row); // Initial calculation for preloaded rows
            });
        }
        updateSymbolCellStyling(); // Apply styling after rendering all rows
    }

    /**
     * Adds a new custom, empty row to the Lot Size Calculator table.
     */
    function addCustomLotSizeRow() {
        const tbody = document.getElementById('lot-size-table-body');
        const newRow = tbody.insertRow();
        const rowCount = tbody.rows.length; // Get current row count for S.No.

        newRow.innerHTML = `
            <td class="px-3 py-2">${rowCount}</td>
            <td class="px-3 py-2 editable-cell" contenteditable="true" data-field="company">Custom Company</td>
            <td class="px-3 py-2 symbol-cell" contenteditable="false" data-field="symbol">CUSTOM</td>
            <td class="px-3 py-2 editable-cell" contenteditable="true" data-field="sector">Custom Sector</td>
            <td class="px-3 py-2"><input type="number" step="0.01" value="0" class="entry-price-input editable-cell input-cell"></td>
            <td class="px-3 py-2"><input type="number" step="0.01" value="0" class="exit-price-input editable-cell input-cell"></td>
            <td class="px-3 py-2"><input type="number" value="1" class="lot-size-input editable-cell input-cell lot-size-display"></td> <!-- Editable lot size for custom -->
            <td class="px-3 py-2"><input type="number" value="1" class="lots-taken-input editable-cell input-cell"></td>
            <td class="px-3 py-2 deployed-capital-display text-right">₹0.00</td>
            <td class="px-3 py-2 gross-pnl-display text-right">₹0.00</td>
            <td class="px-3 py-2 charges-display text-right">₹0.00</td>
            <td class="px-3 py-2 net-pnl-display font-bold text-right">₹0.00</td>
        `;
        addRowEventListeners(newRow);
        updateRowCalculations(newRow); // Initial calculation for new custom row
        document.getElementById('no-lot-data-message').classList.add('hidden'); // Hide no data message if adding first row
        updateSymbolCellStyling(); // Apply styling to the new row's symbol cell
    }

    /**
     * Exports the current state of the Sectors HawkView 🦅 table to a CSV file.
     */
    function exportLotSizeTableAsCSV() {
        const table = document.querySelector('.trade-table');
        let csv = [];
        const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
        csv.push(headers.join(','));

        table.querySelectorAll('tbody tr').forEach(row => {
            const rowData = [];
            // S.No.
            rowData.push(row.cells[0].textContent.trim());
            // Company (contenteditable)
            rowData.push(`"${row.cells[1].textContent.trim()}"`);
            // Symbol (contenteditable)
            rowData.push(`"${row.cells[2].textContent.trim()}"`);
            // Sector (contenteditable)
            rowData.push(`"${row.cells[3].textContent.trim()}"`);
            // Entry ₹ (input)
            rowData.push(row.querySelector('.entry-price-input').value);
            // Exit ₹ (input)
            rowData.push(row.querySelector('.exit-price-input').value);
            // Lot Size (display or input)
            const lotSizeElement = row.querySelector('.lot-size-display');
            rowData.push(lotSizeElement.tagName === 'INPUT' ? lotSizeElement.value : lotSizeElement.textContent.trim());
            // Lots Taken (input)
            rowData.push(row.querySelector('.lots-taken-input').value);
            // Deployed Capital (display) - remove currency symbol
            rowData.push(row.querySelector('.deployed-capital-display').textContent.replace('₹', '').trim());
            // Gross P&L ₹ (display) - remove currency symbol
            rowData.push(row.querySelector('.gross-pnl-display').textContent.replace('₹', '').trim());
            // Charges ₹ (display) - remove currency symbol
            rowData.push(row.querySelector('.charges-display').textContent.replace('₹', '').trim());
            // Net P&L ₹ (display) - remove currency symbol
            rowData.push(row.querySelector('.net-pnl-display').textContent.replace('₹', '').trim());

            csv.push(rowData.join(','));
        });

        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pnl_calculator_data_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage("Success", "Table data exported to CSV!");
    }


    // --- Date & Time and Percentage Circles Logic ---
    function initDateTimeAndPercentages() {
        const currentDateEl = document.getElementById('current-date');
        const currentTimeEl = document.getElementById('current-time');
        const daysMonthEl = document.getElementById('days-month');
        const daysYearEl = document.getElementById('days-year');

        function updateDateTimeAndProgress() {
            const now = new Date();
            const optionsDate = {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                timeZone: 'Asia/Kolkata'
            };
            currentDateEl.textContent = now.toLocaleDateString('en-IN', optionsDate);

            const optionsTime = {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true,
                timeZone: 'Asia/Kolkata'
            };
            currentTimeEl.textContent = now.toLocaleTimeString('en-IN', optionsTime);

            // Days remaining in month
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const daysLeftMonth = daysInMonth - now.getDate();
            daysMonthEl.textContent = `${daysLeftMonth} days`;

            // Days remaining in year
            const startOfYearDate = new Date(now.getFullYear(), 0, 1);
            const endOfYearDate = new Date(now.getFullYear(), 11, 31);
            const totalDaysInYear = Math.ceil((endOfYearDate - startOfYearDate) / (1000 * 60 * 60 * 24)) + 1;
            const passedDaysInYear = Math.floor((now - startOfYearDate) / (1000 * 60 * 60 * 24));
            const daysLeftYear = totalDaysInYear - passedDaysInYear;
            daysYearEl.textContent = `${daysLeftYear} days`;
        }

        updateDateTimeAndProgress();
        setInterval(updateDateTimeAndProgress, 1000); // Update every second
    }

    // --- User-provided Quote Carousel Logic ---
    function initQuotes() {
        const quoteText = document.getElementById('quoteText');
        const quoteAuthor = document.getElementById('quoteAuthor');

        function showRandomQuote() {
            const quote = quotesData[Math.floor(Math.random() * quotesData.length)];
            let text = '';
            let author = '';

            // Ensure quote is an object, or convert string to object
            if (typeof quote === 'string') {
                const parts = quote.split(' - ');
                text = parts[0];
                author = parts.length > 1 ? parts[1] : '';
            } else {
                text = quote.text;
                author = quote.author;
            }

            quoteText.textContent = `"${text}"`;
            quoteAuthor.textContent = author ? `- ${author}` : '';
        }

        showRandomQuote();
        setInterval(showRandomQuote, 10000); // Change quote every 10 seconds
    }

    // --- Theme Toggle Logic ---
    function toggleTheme() {
        const html = document.documentElement;
        if (html.classList.contains('dark')) {
            html.classList.remove('dark');
            html.classList.add('light');
            localStorage.setItem('theme', 'light');
        } else {
            html.classList.remove('light');
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        }
        // Re-render current view to apply new theme colors to charts if needed
        const currentView = document.getElementById('app-content').dataset.currentView;
        showView(currentView); // This will re-render charts with correct colors
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
        if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.add('light');
        } else {
            document.documentElement.classList.remove('light');
            document.documentElement.classList.add('dark');
        }
    }

    // --- Sidebar Collapse/Expand Logic ---
    let sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const sidebarToggleIcon = document.querySelector('#sidebar-toggle i');

        sidebarCollapsed = !sidebarCollapsed;
        localStorage.setItem('sidebarCollapsed', sidebarCollapsed);

        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            if (sidebarToggleIcon) sidebarToggleIcon.setAttribute('data-lucide', 'chevron-right');
        } else {
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
            if (sidebarToggleIcon) sidebarToggleIcon.setAttribute('data-lucide', 'chevron-left');
        }
        lucide.createIcons(); // Re-render icon
    }

    function applySavedSidebarState() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const sidebarToggleIcon = document.querySelector('#sidebar-toggle i');

        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            if (sidebarToggleIcon) sidebarToggleIcon.setAttribute('data-lucide', 'chevron-right');
        } else {
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
            if (sidebarToggleIcon) sidebarToggleIcon.setAttribute('data-lucide', 'chevron-left');
        }
        // lucide.createIcons() is called after this function in DOMContentLoaded
        // so we don't need to call it here.
    }


    // --- Navigation Logic ---
    async function showView(viewId, data = null) {
        const appContent = document.getElementById('app-content');
        appContent.dataset.currentView = viewId; // Store current view

        // Before rendering a new view, destroy all existing charts
        destroyAllCharts();

        // When navigating away from Sectors HawkView 🦅, close the popup/new tab if open
        if (viewId !== 'lot-size-calculator') {
            if (scanModePopup && !scanModePopup.closed) {
                scanModePopup.close();
                scanModePopup = null;
            }
            if (scanModeNewTabWindow && !scanModeNewTabWindow.closed) {
                scanModeNewTabWindow.close();
                scanModeNewTabWindow = null;
            }
            // Also reset scan mode states when navigating away
            scanModeActive = false;
            newTabModeActive = false;
            localStorage.setItem('scanModeActive', false);
            localStorage.setItem('newTabModeActive', false);
            updateScanModeButtonText(); // Update button text to "Scan Mode - Off"
        }

        switch (viewId) {
            case 'dashboard':
                await renderDashboard();
                break;
            case 'add-trade':
                renderAddTradeForm(data); // Pass data for editing
                break;
            case 'view-trades':
                await renderViewTrades();
                break;
            case 'analytics': // New analytics view
                await renderAnalytics();
                break;
            case 'reflections':
                await renderReflections();
                break;
            case 'lot-size-calculator': // Now Sectors HawkView 🦅 view
                renderLotSizeCalculator();
                break;
            // case 'brokerage-calculator': // Removed
            //     renderBrokerageCalculator();
            //     break;
            case 'settings':
                renderSettings();
                break;
            default:
                await renderDashboard(); // Default to dashboard
        }
        // Close sidebar on mobile after navigation
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
        // Highlight active nav link - Adjusted to use fixed colors for sidebar links
        document.querySelectorAll('nav ul li a').forEach(link => {
            link.classList.remove('bg-indigo-700', 'text-white'); // Remove old classes
            if (link.id === `nav-${viewId}`) {
                link.classList.add('bg-indigo-700', 'text-white'); // Add specific classes for active state
            }
        });
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Lucide icons first, so elements with data-lucide attributes are processed
        lucide.createIcons();

        applySavedTheme();
        applySavedSidebarState(); // Apply sidebar state on load
        await openDB(); // Open IndexedDB when DOM is ready

        // Initial rendering of user's header elements
        initDateTimeAndPercentages();
        initQuotes();

        showView('dashboard'); // Show dashboard on initial load

        // Navigation event listeners
        document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showView('dashboard'); });
        document.getElementById('nav-add-trade').addEventListener('click', (e) => { e.preventDefault(); showView('add-trade'); });
        document.getElementById('nav-view-trades').addEventListener('click', (e) => { e.preventDefault(); showView('view-trades'); });
        document.getElementById('nav-analytics').addEventListener('click', (e) => { e.preventDefault(); showView('analytics'); });
        document.getElementById('nav-reflections').addEventListener('click', (e) => { e.preventDefault(); showView('reflections'); });
        document.getElementById('nav-lot-size-calculator').addEventListener('click', (e) => { e.preventDefault(); showView('lot-size-calculator'); });
        document.getElementById('nav-settings').addEventListener('click', (e) => { e.preventDefault(); showView('settings'); });

        // Theme toggle button in sidebar
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

        // Sidebar collapse toggle
        document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);

        // Mobile menu toggle
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active'); // Use 'active' class for mobile toggle
        });
        // Hide sidebar if clicking outside on mobile
        document.addEventListener('click', (event) => {
            // If it's a mobile view and sidebar is active AND click is outside sidebar AND not on menu toggle
            if (window.innerWidth <= 768 && sidebar.classList.contains('active') &&
                !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                sidebar.classList.remove('active');
            }
        });


        // Handle window resize for sidebar visibility
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active'); /* Ensure it's not 'active' (overlay) on desktop */
                // sidebar will stay fixed due to its CSS definition
            } else {
                // If resized to mobile, ensure sidebar is hidden unless explicitly opened
                if (!sidebar.classList.contains('active')) { // If sidebar is currently not active (hidden)
                    // Do nothing, keep it hidden by default until toggle
                }
            }
        });

        // Ctrl/Cmd+Shift+S to toggle Scan Mode (Global listener)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 's') { // Added e.metaKey for Cmd key
                e.preventDefault(); // Avoid browser Save dialog
                toggleScanMode();
            } else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'k') { // Added e.metaKey for Cmd key
                e.preventDefault(); // Avoid browser shortcuts
                toggleNewTabMode();
            }
        });
    });
</script>
</body>
</html>
